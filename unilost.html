<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UniLost - êµë‚´ ë¶„ì‹¤ë¬¼ í†µí•© ê´€ë¦¬</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet (defer + í´ë°±) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"
          onerror="(function(){var s=document.createElement('script');s.defer=true;s.src='https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js';document.head.appendChild(s);}())"></script>

  <style>
    html, body { height: 100%; }
    body { margin: 0; }
    #mapRegister { height: 70vh; min-height: 320px; width: 100%; }
    #mapBrowse   { height: 60vh; min-height: 300px; width: 100%; }
    .u-ellipsis  { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    /* ë“œë¡œì–´ê°€ ì§€ë„ë³´ë‹¤ í•­ìƒ ìœ„ */
    .leaflet-container { z-index: 0; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="sticky top-0 z-20 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="text-xl font-bold">ğŸ’ UniLost - êµë‚´ ë¶„ì‹¤ë¬¼ í†µí•© ê´€ë¦¬</div>
      <div id="authStatus" class="ml-2 text-sm text-slate-600"></div>
      <nav class="ml-auto flex gap-2 items-center">
        <button id="tabRegisterBtn" class="px-3 py-1.5 rounded-lg bg-indigo-600 text-white">ë¶„ì‹¤ë¬¼ ë“±ë¡</button>
        <button id="tabBrowseBtn"   class="px-3 py-1.5 rounded-lg bg-slate-200">ê²€ìƒ‰/ì§€ë„</button>
        <button id="tabAdminBtn"    class="px-3 py-1.5 rounded-lg bg-slate-200">ê´€ë¦¬ì</button>
        <button id="tabChatBtn"     class="px-3 py-1.5 rounded-lg bg-slate-200">ì±„íŒ…</button>
        <button id="btnLoginToggle" class="px-3 py-1.5 rounded-lg bg-slate-800 text-white">ë¡œê·¸ì¸</button>
      </nav>
    </div>
  </header>

  <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
  <div id="loginModal" class="fixed inset-0 hidden items-center justify-center bg-black/30 z-50">
    <div class="bg-white w-80 p-6 rounded-2xl shadow-xl">
      <h2 class="text-lg font-semibold mb-4 text-center">ë¡œê·¸ì¸</h2>
      <input id="loginId" class="w-full border rounded-lg px-3 py-2 mb-2" placeholder="ì•„ì´ë”” (ì˜ˆ: student1 / admin1)" />
      <input id="loginPw" type="password" class="w-full border rounded-lg px-3 py-2 mb-3" placeholder="ë¹„ë°€ë²ˆí˜¸ (ì˜ˆ: 1234 / admin123)" />
      <div class="flex justify-end gap-2">
        <button id="btnCancelLogin" class="px-3 py-2 rounded bg-slate-200">ì·¨ì†Œ</button>
        <button id="btnDoLogin" class="px-3 py-2 rounded bg-indigo-600 text-white">ë¡œê·¸ì¸</button>
      </div>
    </div>
  </div>

  <!-- ë“œë¡œì–´ìš© ë°±ë“œë¡­(ì§€ë„ ìœ„ ì–´ë‘¡ê²Œ) -->
  <div id="drawerBackdrop" class="fixed inset-0 bg-black/30 hidden z-[1100]"></div>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <!-- ë¶„ì‹¤ë¬¼ ë“±ë¡ -->
    <section id="tabRegister" class="grid md:grid-cols-2 gap-6">
      <div class="bg-white rounded-2xl shadow p-4 space-y-4">
        <h2 class="text-lg font-semibold">ë¶„ì‹¤ë¬¼ ë“±ë¡</h2>

        <div class="grid gap-3">
          <label class="text-sm">ì‚¬ì§„ ì—…ë¡œë“œ</label>
          <input id="inImage" type="file" accept="image/*" class="block w-full" />
          <img id="preview" class="mt-2 max-h-48 rounded-lg hidden" alt="ë¯¸ë¦¬ë³´ê¸°" />
        </div>

        <div class="grid gap-3">
          <label class="text-sm">ë¶„ì‹¤ë¬¼ ì´ë¦„/ê°„ë‹¨ ì„¤ëª…</label>
          <input id="inTitle" class="w-full border rounded-lg px-3 py-2" placeholder="ì˜ˆ) ê²€ì • ì§€ê°‘, íŒŒë€ ìš°ì‚°, ì—ì–´íŒŸ ì¼€ì´ìŠ¤" />
          <textarea id="inDesc" rows="3" class="w-full border rounded-lg px-3 py-2" placeholder="ìƒì„¸ ì„¤ëª… (ìƒ‰ìƒ, ë¸Œëœë“œ, íŠ¹ì§•, ë°œê²¬/ë¶„ì‹¤ ìƒí™©)"></textarea>
          <div class="text-xs text-slate-500">â€» ì„¤ëª…ì„ ê¸°ë°˜ìœ¼ë¡œ ìë™ ë¶„ë¥˜ë©ë‹ˆë‹¤. í•„ìš”ì‹œ ìˆ˜ë™ ë³€ê²½ ê°€ëŠ¥.</div>
        </div>

        <div class="grid gap-2">
          <label class="text-sm">ìë™ ë¶„ë¥˜ ê²°ê³¼</label>
          <div class="flex gap-2">
            <input id="inCategory" class="flex-1 border rounded-lg px-3 py-2" placeholder="ìë™ ë¶„ë¥˜ ëŒ€ê¸° ì¤‘â€¦" />
            <button id="btnClassify" class="px-3 py-2 rounded-lg bg-indigo-600 text-white">ìë™ ë¶„ë¥˜</button>
          </div>
        </div>

        <div class="grid gap-2">
          <label class="text-sm">ìœ„ì¹˜(ì£¼ì†Œ) ì…ë ¥</label>
          <div class="flex gap-2">
            <input id="inAddress" class="flex-1 border rounded-lg px-3 py-2" placeholder="ì˜ˆ) ì„¸ì¢…ëŒ€í•™êµ êµ°ìê´€, ì„œìš¸ ê´‘ì§„êµ¬ ëŠ¥ë™ë¡œ 209" />
            <button id="btnGeocode" class="px-3 py-2 rounded-lg bg-slate-800 text-white">ì£¼ì†Œ ì°¾ê¸°</button>
          </div>
          <div class="text-xs text-slate-500">ë˜ëŠ” <b>ì§€ë„ í´ë¦­</b>ìœ¼ë¡œ ìœ„ì¹˜ ì§€ì •</div>
          <div class="grid grid-cols-2 gap-2">
            <input id="inLat" class="border rounded-lg px-3 py-2" placeholder="ìœ„ë„" />
            <input id="inLng" class="border rounded-lg px-3 py-2" placeholder="ê²½ë„" />
          </div>
        </div>

        <div class="flex items-center gap-2">
          <label class="text-sm">ì •í™•ë„ ë°˜ê²½(ë¯¸í„°)</label>
          <input id="inRadius" type="number" min="0" value="50" class="w-32 border rounded-lg px-3 py-2" />
        </div>

        <!-- ìƒˆë¡œ ì¶”ê°€: ë“±ë¡ ì‹œ ë³´ê´€ ì¥ì†Œ -->
        <div class="grid gap-2">
          <label class="text-sm">ë³´ê´€ ì¥ì†Œ (ì„ íƒ)</label>
          <input id="inStoragePlaceReg" class="w-full border rounded-lg px-3 py-2"
                 placeholder="ì˜ˆ: í•™ìƒìƒí™œê³¼ 1ì¸µ ë³´ê´€í•¨ A-3" />
        </div>

        <div class="flex gap-2">
          <button id="btnSubmit" class="px-4 py-2 rounded-xl bg-green-600 text-white">ë“±ë¡ ìš”ì²­</button>
          <button id="btnResetForm" class="px-4 py-2 rounded-xl bg-slate-200">ì´ˆê¸°í™”</button>
        </div>

        <p id="guardNotice" class="text-xs text-rose-600 hidden">â€» ë“±ë¡í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>
      </div>

      <div class="bg-white rounded-2xl shadow p-4">
        <h3 class="text-sm font-semibold mb-2">ì§€ë„ì—ì„œ ìœ„ì¹˜ í™•ì¸</h3>
        <div id="mapRegister" class="rounded-xl overflow-hidden"></div>
        <p class="mt-2 text-xs text-slate-500">ì£¼ì†Œ ì…ë ¥ í›„ <b>ì£¼ì†Œ ì°¾ê¸°</b>ë¥¼ ëˆ„ë¥´ê±°ë‚˜, ì§€ë„ë¥¼ í´ë¦­í•´ ì¢Œí‘œë¥¼ ì§€ì •í•˜ì„¸ìš”.</p>
      </div>
    </section>

    <!-- ê²€ìƒ‰/ì§€ë„ -->
    <section id="tabBrowse" class="hidden">
      <div class="grid md:grid-cols-3 gap-6">
        <div class="md:col-span-1 bg-white rounded-2xl shadow p-4 space-y-3">
          <h2 class="text-lg font-semibold">ë¶„ì‹¤ë¬¼ ê²€ìƒ‰</h2>
          <input id="qText" class="w-full border rounded-lg px-3 py-2" placeholder="í‚¤ì›Œë“œ (ì˜ˆ: ì§€ê°‘, íŒŒë€, ì—ì–´íŒŸ)" />
          <select id="qCategory" class="w-full border rounded-lg px-3 py-2">
            <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
            <option>ì§€ê°‘</option><option>í•™ìƒì¦/ì¹´ë“œ</option><option>ì „ìê¸°ê¸°</option>
            <option>ì´ì–´í°/ì—ì–´íŒŸ</option><option>ë…¸íŠ¸ë¶</option><option>ìš°ì‚°</option>
            <option>ì˜ë¥˜</option><option>ì„œì /ë…¸íŠ¸</option><option>ê¸°íƒ€</option>
          </select>
          <div class="flex items-center gap-2 text-sm">
            <input id="qOnlyApproved" type="checkbox" checked>
            <label for="qOnlyApproved">ìŠ¹ì¸ëœ í•­ëª©ë§Œ</label>
          </div>
          <button id="btnSearch" class="w-full mt-1 px-3 py-2 rounded-lg bg-indigo-600 text-white">ê²€ìƒ‰</button>
          <div class="text-xs text-slate-500">ëª©ë¡ì—ì„œ í•­ëª©ì„ í´ë¦­í•˜ë©´ ì§€ë„ í¬ì»¤ìŠ¤ & ë“œë¡œì–´ê°€ ì—´ë¦½ë‹ˆë‹¤.</div>
          <hr class="my-2" />
          <div class="flex gap-2">
            <button id="btnExport" class="flex-1 px-3 py-2 rounded-lg bg-slate-100">JSON ë‚´ë³´ë‚´ê¸°</button>
            <label class="flex-1 px-3 py-2 rounded-lg bg-slate-100 text-center cursor-pointer">
              JSON ê°€ì ¸ì˜¤ê¸°<input id="inImport" type="file" accept="application/json" class="hidden" />
            </label>
          </div>
        </div>

        <div class="md:col-span-2 bg-white rounded-2xl shadow p-4 relative">
          <h3 class="text-sm font-semibold mb-2">ì§€ë„ & ëª©ë¡</h3>
          <div id="mapBrowse" class="rounded-xl overflow-hidden"></div>
          <ul id="listResults" class="mt-3 divide-y"></ul>
        </div>
      </div>

      <!-- í•­ëª© ìƒì„¸ + ìŠ¤ë ˆë“œ ì±„íŒ… ë“œë¡œì–´ (í•­ìƒ ì½ê¸° ì „ìš©) -->
      <div id="itemDrawer" class="fixed inset-y-0 right-0 w-full sm:w-[480px] bg-white shadow-2xl border-l border-slate-200 hidden z-[1200]">
        <div class="h-full flex flex-col">
          <div class="flex items-center gap-2 px-4 py-3 border-b">
            <button id="btnCloseDrawer" class="px-3 py-1.5 rounded bg-slate-100">ë‹«ê¸°</button>
            <div id="drawerTitle" class="ml-2 font-semibold truncate">í•­ëª©</div>
          </div>
          <div class="p-4 space-y-3 overflow-auto">
            <img id="drawerImg" class="w-full max-h-48 object-cover rounded-lg bg-slate-100 hidden" alt="">
            <div class="text-sm text-slate-600"><span id="drawerMeta"></span></div>
            <div class="text-sm whitespace-pre-wrap" id="drawerDesc"></div>
            <div class="text-sm">
              <div class="font-medium">ë³´ê´€ ì¥ì†Œ</div>
              <div id="drawerStorageView" class="text-slate-700"></div>
              <!-- ë“œë¡œì–´ì—ì„œëŠ” í•­ìƒ ìˆ˜ì • ë¶ˆê°€ -->
              <div id="drawerStorageEdit" class="hidden mt-2 gap-2 sm:flex">
                <input id="inStoragePlace" class="flex-1 border rounded-lg px-3 py-2" />
                <button id="btnSaveStorage" class="px-3 py-2 rounded-lg bg-emerald-600 text-white">ì €ì¥</button>
              </div>
            </div>
            <hr/>
            <div>
              <div class="font-semibold">ìŠ¤ë ˆë“œ ì±„íŒ…</div>
              <div id="threadConn" class="inline-block text-xs px-2 py-0.5 rounded bg-slate-200 mt-1">ì—°ê²° ëŒ€ê¸°</div>
              <div id="threadLog" class="h-64 mt-2 border rounded-xl p-2 overflow-auto space-y-2"></div>
              <div class="mt-2 flex gap-2">
                <input id="threadNick" class="w-32 border rounded-lg px-2 py-2" placeholder="ë‹‰ë„¤ì„" />
                <input id="threadMsg" class="flex-1 border rounded-lg px-3 py-2" placeholder="ë©”ì‹œì§€ (Enter ì „ì†¡)" />
                <button id="btnThreadSend" class="px-3 py-2 rounded-lg bg-indigo-600 text-white">ë³´ë‚´ê¸°</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ê´€ë¦¬ì -->
    <section id="tabAdmin" class="hidden">
      <div class="bg-white rounded-2xl shadow p-4">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">ê´€ë¦¬ì ìŠ¹ì¸</h2>
          <div class="flex gap-2 items-center text-sm">
            <span class="text-slate-600">ê´€ë¦¬ì ë¡œê·¸ì¸ í•„ìš”</span>
            <span id="adminStatus" class="text-xs text-slate-500 ml-1">ê¶Œí•œ ì—†ìŒ</span>
          </div>
        </div>
        <div class="mt-4 grid md:grid-cols-2 gap-4">
          <div>
            <h3 class="font-semibold mb-2">ëŒ€ê¸°(ë¯¸ìŠ¹ì¸)</h3>
            <ul id="pendingList" class="divide-y"></ul>
          </div>
          <div>
            <h3 class="font-semibold mb-2">ìŠ¹ì¸ë¨</h3>
            <ul id="approvedList" class="divide-y"></ul>
          </div>
        </div>
      </div>
    </section>

    <!-- ì „ì—­ ì±„íŒ… -->
    <section id="tabChat" class="hidden">
      <div class="grid md:grid-cols-3 gap-6">
        <div class="md:col-span-1 bg-white rounded-2xl shadow p-4 space-y-3">
          <h2 class="text-lg font-semibold">í•™ìƒ/ê´€ë¦¬ì ì±„íŒ…</h2>
          <input id="chatNick" class="w-full border rounded-lg px-3 py-2" placeholder="ë‹‰ë„¤ì„ (ë¯¸ì…ë ¥ì‹œ ìµëª…)" />
          <textarea id="chatMsg" rows="3" class="w-full border rounded-lg px-3 py-2" placeholder="ë©”ì‹œì§€"></textarea>
          <button id="btnSend" class="w-full px-3 py-2 rounded-lg bg-indigo-600 text-white">ë³´ë‚´ê¸° (Enter)</button>
          <div class="text-xs"><span id="chatConn" class="px-2 py-0.5 rounded bg-slate-200">ì—°ê²° ëŒ€ê¸°</span></div>
        </div>
        <div class="md:col-span-2 bg-white rounded-2xl shadow p-4">
          <h3 class="text-sm font-semibold mb-2">ì±„íŒ… ë¡œê·¸</h3>
          <div id="chatLog" class="h-[60vh] overflow-auto space-y-2"></div>
        </div>
      </div>
    </section>
  </main>

  <footer class="max-w-7xl mx-auto px-4 pb-10 text-xs text-slate-500">
    ë°ì´í„°ëŠ” <b>SQLite ë°ì´í„°ë² ì´ìŠ¤</b>ì— ì €ì¥ë©ë‹ˆë‹¤. ì„œë²„ ì¬ì‹œì‘ í›„ì—ë„ ë°ì´í„°ê°€ ë³´ì¡´ë©ë‹ˆë‹¤.
  </footer>

  <script>
  // ===== ê³µìš© ìƒíƒœ/ìœ í‹¸ =====
  const defaultLat = 37.5519, defaultLng = 127.0732; // ì„¸ì¢…ëŒ€ ê·¼ì²˜
  const $ = (id) => document.getElementById(id);
  let itemsCache = []; // í•­ëª© ìºì‹œ
  const STORE_KEY = 'lostItems_v2'; // ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•Šì§€ë§Œ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€
  
  // APIë¥¼ í†µí•œ í•­ëª© ë¡œë“œ
  async function loadItems() {
    try {
      const res = await fetch('/api/items', { credentials: 'same-origin' });
      if (!res.ok) throw new Error('í•­ëª© ë¡œë“œ ì‹¤íŒ¨');
      itemsCache = await res.json();
      return itemsCache;
    } catch (err) {
      console.error('í•­ëª© ë¡œë“œ ì˜¤ë¥˜:', err);
      return itemsCache; // ìºì‹œëœ ë°ì´í„° ë°˜í™˜
    }
  }
  
  // í•­ëª© ìƒˆë¡œê³ ì¹¨ (ìºì‹œ ì—…ë°ì´íŠ¸)
  async function refreshItems() {
    itemsCache = await loadItems();
    return itemsCache;
  }
  const RULES = [
    { kw: [/ì—ì–´íŒŸ|airpod|ì´ì–´í°|ë²„ì¦ˆ/i], cat:'ì´ì–´í°/ì—ì–´íŒŸ' }, { kw:[/ì§€ê°‘|wallet|ì¹´ë“œì§€ê°‘/i],cat:'ì§€ê°‘' },
    { kw: [/í•™ìƒì¦|ì‹ ë¶„ì¦|ì¹´ë“œ|í•™ë²ˆ/i],cat:'í•™ìƒì¦/ì¹´ë“œ' }, { kw:[/ë…¸íŠ¸ë¶|laptop|ë§¥ë¶|ê·¸ë¨/i],cat:'ë…¸íŠ¸ë¶' },
    { kw: [/ì•„ì´íŒ¨ë“œ|íƒœë¸”ë¦¿|ipad/i],cat:'ì „ìê¸°ê¸°' }, { kw:[/í•¸ë“œí°|ìŠ¤ë§ˆíŠ¸í°|íœ´ëŒ€í°|iphone|galaxy|í°/i],cat:'ì „ìê¸°ê¸°' },
    { kw: [/ìš°ì‚°/i],cat:'ìš°ì‚°' }, { kw:[/í›„ë“œ|ì½”íŠ¸|ì˜·|ìì¼“|ì í¼|íŒ¨ë”©/i],cat:'ì˜ë¥˜' }, { kw:[/ì±…|êµì¬|ë…¸íŠ¸|ìˆ˜ì²©/i],cat:'ì„œì /ë…¸íŠ¸' },
  ];
  const autoClassify = (t='') => { const s=t.toLowerCase(); for (const r of RULES) if (r.kw.some(rx=>rx.test(s))) return r.cat; return 'ê¸°íƒ€'; };

  // ===== ì¸ì¦ ìƒíƒœ =====
  let ME = null;  // {id, name, isAdmin} | null

  async function fetchMe(){
    const res = await fetch('/api/me', { credentials: 'same-origin' });
    const { user } = await res.json();
    ME = user || null;
    updateAuthUI();
  }
  async function doLogin(id, pw){
    const res = await fetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ id, pw })
    });
    if (!res.ok){
      const e = await res.json().catch(()=>({error:'ë¡œê·¸ì¸ ì‹¤íŒ¨'}));
      throw new Error(e.error||'ë¡œê·¸ì¸ ì‹¤íŒ¨');
    }
    ME = (await res.json()).user;
    updateAuthUI();
  }
  async function doLogout(){
    await fetch('/api/logout', { method:'POST', credentials: 'same-origin' });
    ME = null; updateAuthUI();
  }

  async function updateAuthUI(){
    const s = $('authStatus');
    s.textContent = ME ? `ì•ˆë…•í•˜ì„¸ìš”, ${ME.name}ë‹˜` : 'ë¡œê·¸ì¸í•˜ì§€ ì•ŠìŒ';
    const btn = $('btnLoginToggle');
    btn.textContent = ME ? 'ë¡œê·¸ì•„ì›ƒ' : 'ë¡œê·¸ì¸';
    btn.onclick = ()=> ME ? doLogout() : showLoginModal();

    const canSubmit = !!ME;
    $('btnSubmit').disabled = !canSubmit;
    $('btnSubmit').classList.toggle('opacity-50', !canSubmit);
    $('guardNotice').classList.toggle('hidden', canSubmit);

    const admin = !!(ME && ME.isAdmin);
    $('adminStatus').textContent = admin ? 'ê´€ë¦¬ì ê¶Œí•œ ë³´ìœ ' : 'ê¶Œí•œ ì—†ìŒ';

    await renderAdminLists();
    await renderBrowse();
  }

  function showLoginModal(){ $('loginModal').classList.remove('hidden'); }
  function hideLoginModal(){ $('loginModal').classList.add('hidden'); }
  $('btnCancelLogin').onclick = hideLoginModal;
  $('btnDoLogin').onclick = async ()=>{
    const id = $('loginId').value.trim();
    const pw = $('loginPw').value.trim();
    if (!id || !pw) return alert('ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
    try { await doLogin(id, pw); hideLoginModal(); }
    catch(e){ alert(e.message||'ë¡œê·¸ì¸ ì‹¤íŒ¨'); }
  };

  // ===== ì§€ë„ =====
  let mapRegister, mapBrowse, registerMarker, registerCircle, regRO, brRO;
  let browseMarkers = [];
  function initRegisterMap(){
    const el = $('mapRegister'); if (!el || mapRegister) return;
    if (el.offsetParent===null || el.clientHeight===0 || el.clientWidth===0){ setTimeout(initRegisterMap,120); return; }
    mapRegister = L.map('mapRegister');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'Â© OpenStreetMap contributors'}).addTo(mapRegister);
    setRegisterLocation(defaultLat, defaultLng, true);
    mapRegister.on('click', e=> setRegisterLocation(e.latlng.lat, e.latlng.lng, false));
    setTimeout(()=> mapRegister.invalidateSize(), 50);
    regRO = new ResizeObserver(()=> mapRegister && mapRegister.invalidateSize()); regRO.observe(el);
  }
  function setRegisterLocation(lat, lng, first){
    $('inLat').value = (lat??defaultLat).toFixed(6);
    $('inLng').value = (lng??defaultLng).toFixed(6);
    if (registerMarker) registerMarker.remove();
    if (registerCircle) registerCircle.remove();
    registerMarker = L.marker([lat,lng]).addTo(mapRegister).bindPopup('ë“±ë¡ ìœ„ì¹˜');
    const r = Number($('inRadius').value||0);
    if (r>0) registerCircle = L.circle([lat,lng], {radius:r, fillOpacity:.15}).addTo(mapRegister);
    mapRegister.setView([lat,lng], first?15:16); registerMarker.openPopup();
  }
  function initBrowseMap(){
    const el = $('mapBrowse'); if (!el || mapBrowse) return;
    if (el.offsetParent===null || el.clientHeight===0 || el.clientWidth===0){ setTimeout(initBrowseMap,120); return; }
    mapBrowse = L.map('mapBrowse');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'Â© OpenStreetMap contributors'}).addTo(mapBrowse);
    mapBrowse.setView([defaultLat, defaultLng], 15);
    renderBrowse();
    setTimeout(()=> mapBrowse.invalidateSize(), 50);
    brRO = new ResizeObserver(()=> mapBrowse && mapBrowse.invalidateSize()); brRO.observe(el);
  }
  function clearBrowseMarkers(){ browseMarkers.forEach(m=>m.remove()); browseMarkers=[]; }

  // ===== ì§€ì˜¤ì½”ë”© =====
  async function geocode(address){
    const url = new URL('https://nominatim.openstreetmap.org/search');
    url.search = new URLSearchParams({ q: address, format: 'json', addressdetails: 1 }).toString();
    const res = await fetch(url, { headers: { 'Accept-Language': 'ko' } });
    if (!res.ok) throw new Error('ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨');
    return res.json();
  }

  // ===== ë“±ë¡ í¼ =====
  function bindRegisterForm(){
    const inImage=$('inImage'), preview=$('preview'), inTitle=$('inTitle'), inDesc=$('inDesc'), inCategory=$('inCategory');

    inImage.addEventListener('change', ()=>{
      const f=inImage.files?.[0];
      if(!f){ preview.classList.add('hidden'); preview.src=''; return; }
      const fr=new FileReader(); fr.onload=()=>{ preview.src=fr.result; preview.classList.remove('hidden'); }; fr.readAsDataURL(f);
      if(!inCategory.value) inCategory.value = autoClassify(f.name||'');
    });
    $('btnClassify').addEventListener('click', ()=> inCategory.value = autoClassify(`${inTitle.value}\n${inDesc.value}`));
    $('btnGeocode').addEventListener('click', async ()=>{
      const q=$('inAddress').value.trim(); if(!q) return alert('ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
      try{
        const results=await geocode(q); if(!results.length) return alert('ì£¼ì†Œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        const {lat,lon,display_name}=results[0]; setRegisterLocation(parseFloat(lat), parseFloat(lon), false);
        if (registerMarker) registerMarker.bindPopup(`<b>ë¶„ì‹¤ë¬¼ ìœ„ì¹˜</b><br>${display_name}`).openPopup();
      }catch(e){ alert(e.message||'ì§€ì˜¤ì½”ë”© ì˜¤ë¥˜'); }
    });
    $('inRadius').addEventListener('change', ()=>{
      const lat=parseFloat($('inLat').value||defaultLat), lng=parseFloat($('inLng').value||defaultLng);
      setRegisterLocation(lat,lng,false);
    });

    $('btnResetForm').addEventListener('click', ()=>{
      inImage.value=''; preview.src=''; preview.classList.add('hidden');
      inTitle.value=''; inDesc.value=''; inCategory.value=''; $('inAddress').value='';
      $('inLat').value=defaultLat; $('inLng').value=defaultLng; $('inRadius').value=50;
      const sp=$('inStoragePlaceReg'); if (sp) sp.value='';
      setRegisterLocation(defaultLat, defaultLng, true);
    });

    $('btnSubmit').addEventListener('click', async ()=>{
      if (!ME) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      const title=inTitle.value.trim(); if(!title) return alert('ë¶„ì‹¤ë¬¼ ì´ë¦„/ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
      const desc=inDesc.value.trim(); let cat=inCategory.value.trim(); if(!cat) cat=autoClassify(`${title}\n${desc}`);
      const lat=parseFloat($('inLat').value), lng=parseFloat($('inLng').value); const radius=Number($('inRadius').value||0);

      // ë“±ë¡ ì‹œ ë³´ê´€ ì¥ì†Œ
      const storagePlace = ($('inStoragePlaceReg').value || '').trim();

      let imgData=''; const f=inImage.files?.[0];
      if(f){ imgData = await new Promise(r=>{ const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(f); }); }

      try {
        const res = await fetch('/api/items', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ title, desc, cat, imgData, lat, lng, radius, storagePlace })
        });
        
        if (!res.ok) {
          const err = await res.json().catch(() => ({ error: 'ë“±ë¡ ì‹¤íŒ¨' }));
          throw new Error(err.error || 'ë“±ë¡ ì‹¤íŒ¨');
        }
        
        await refreshItems();
        alert('ë“±ë¡ ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ì ìŠ¹ì¸ í›„ ê³µê°œë©ë‹ˆë‹¤.');
        $('btnResetForm').click();
        renderAdminLists();
        renderBrowse();
      } catch (err) {
        alert(err.message || 'ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });
  }

  // ===== ê²€ìƒ‰/ì§€ë„ + ë“œë¡œì–´ =====
  async function renderBrowse(){
    if (!mapBrowse) return;
    const items = await loadItems();
    const qText=$('qText').value.trim().toLowerCase(), qCategory=$('qCategory').value, onlyApproved=$('qOnlyApproved').checked;
    const filtered=items.filter(it=>{
      if (onlyApproved && it.status!=='approved') return false;
      if (qCategory && it.cat!==qCategory) return false;
      if (qText){ const blob = `${it.title} ${it.desc} ${it.cat}`.toLowerCase(); if (!blob.includes(qText)) return false; }
      return true;
    }).sort((a,b)=>(b.created_at||'').localeCompare(a.created_at||''));

    const ul=$('listResults'); ul.innerHTML='';
    filtered.forEach(it=>{
      const li=document.createElement('li');
      li.className='py-2 flex gap-3 items-center cursor-pointer hover:bg-slate-50 px-2 rounded';
      li.innerHTML=`
        <img src="${it.imgData||''}" class="w-12 h-12 object-cover rounded-lg bg-slate-100 ${it.imgData?'':'hidden'}" alt="">
        <div class="flex-1 min-w-0">
          <div class="font-medium u-ellipsis">${it.title}<span class="text-xs text-slate-500"> (${it.cat}${it.storagePlace?` Â· ë³´ê´€:${it.storagePlace}`:''})</span></div>
          <div class="text-xs text-slate-500 u-ellipsis">${it.desc||''}</div>
          <div class="text-[10px] text-slate-400">${it.status} â€¢ ${new Date(it.created_at).toLocaleString()}</div>
        </div>`;
      li.addEventListener('click', ()=>{ mapBrowse.setView([it.lat,it.lng], 17); openItemDrawer(it.id); });
      ul.appendChild(li);
    });

    clearBrowseMarkers();
    filtered.forEach(it=>{
      const mk=L.marker([it.lat,it.lng]).addTo(mapBrowse).bindPopup(`
        <b>${it.title}</b><br/>
        <span class="text-xs">${it.cat}${it.storagePlace?` Â· ë³´ê´€:${it.storagePlace}`:''} â€¢ ${new Date(it.created_at).toLocaleString()}</span><br/>
        <span class="text-xs">${(it.desc||'').replace(/[\n\r]+/g,' ')}</span>
      `);
      browseMarkers.push(mk);
      if (it.radius>0){ const circle=L.circle([it.lat,it.lng],{radius:it.radius,fillOpacity:.12}); circle.addTo(mapBrowse); browseMarkers.push(circle); }
      mk.on('click', ()=> openItemDrawer(it.id));
    });
  }

  async function openItemDrawer(itemId){
    const items = await loadItems();
    const it=items.find(x=>x.id===itemId); if(!it) return;

    $('drawerBackdrop').classList.remove('hidden');
    $('itemDrawer').classList.remove('hidden');

    $('drawerTitle').textContent=`${it.title} (#${it.id})`;
    const img=$('drawerImg'); if(it.imgData){ img.src=it.imgData; img.classList.remove('hidden'); } else { img.classList.add('hidden'); }
    $('drawerMeta').textContent=`${it.cat} â€¢ ${new Date(it.created_at).toLocaleString()}`;
    $('drawerDesc').textContent=it.desc||'';
    $('drawerStorageView').textContent=it.storagePlace||'â€”';

    // ë“œë¡œì–´ì—ì„œëŠ” í•­ìƒ ì½ê¸° ì „ìš©
    const editWrap=$('drawerStorageEdit'); if (editWrap) editWrap.classList.add('hidden');

    // ìŠ¤ë ˆë“œ ì±„íŒ…
    // Socketì´ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì´ˆê¸°í™” ì‹œë„
    if (!socket && window.io) {
      initChat();
    }
    // Socket ì—°ê²° ìƒíƒœì— ë”°ë¼ ë°°ì§€ ì„¤ì •
    if (socket && socket.connected) {
      setThreadConnBadge('connected');
      joinThread(it.id);
    } else {
      setThreadConnBadge('disconnected');
      // Socketì´ ì—°ê²°ë˜ë©´ ìë™ìœ¼ë¡œ joiní•˜ë„ë¡ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      if (socket) {
        const onConnect = () => {
          setThreadConnBadge('connected');
          joinThread(it.id);
          socket.off('connect', onConnect);
        };
        socket.on('connect', onConnect);
      }
    }

    const sendThread=()=>{
      const text=$('threadMsg').value.trim(); if(!text) return;
      const nick=$('threadNick').value.trim() || (ME?.name||'ìµëª…');
      if (!socket || !socket.connected) {
        alert('ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
      }
      socket.emit('thread:send', { itemId: it.id, nick, text, ts: new Date().toISOString() });
      $('threadMsg').value='';
      // ì„œë²„ì—ì„œ thread:new ì´ë²¤íŠ¸ë¥¼ ë°›ì•„ì„œ ì¶”ê°€ë˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì¶”ê°€í•˜ì§€ ì•ŠìŒ
    };
    $('btnThreadSend').onclick=sendThread;
    $('threadMsg').onkeydown=(e)=>{ if(e.key==='Enter'&& !e.shiftKey){ e.preventDefault(); sendThread(); } };

    setTimeout(()=> mapBrowse?.invalidateSize(), 60);
  }

  // ===== ê´€ë¦¬ì ëª©ë¡ =====
  async function renderAdminLists(){
    const admin = !!(ME && ME.isAdmin);
    const items = await loadItems();
    const pending=items.filter(it=>it.status!=='approved').sort((a,b)=>(a.created_at||'').localeCompare(b.created_at||'')); // ì˜¤ë˜ëœ ìˆœ
    const approved=items.filter(it=>it.status==='approved').sort((a,b)=>(b.created_at||'').localeCompare(a.created_at||'')); // ìµœì‹  ìˆœ

    const pendingList=$('pendingList'), approvedList=$('approvedList');
    pendingList.innerHTML=''; approvedList.innerHTML='';

    const mkRow=(it, pendingMode)=>{
      const li=document.createElement('li');
      li.className='py-3 flex flex-col gap-2';
      li.innerHTML=`
        <div class="flex gap-3 items-center">
          <img src="${it.imgData||''}" class="w-14 h-14 object-cover rounded-lg bg-slate-100 ${it.imgData?'':'hidden'}" alt="">
          <div class="flex-1 min-w-0">
            <div class="font-medium u-ellipsis">${it.title} <span class="text-xs text-slate-500">(${it.cat})</span></div>
            <div class="text-xs text-slate-500 u-ellipsis">${it.desc||''}</div>
            <div class="text-[10px] text-slate-400">#${it.id} â€¢ ${it.status} â€¢ ${new Date(it.created_at).toLocaleString()}</div>
          </div>
          ${pendingMode ? `
            <div class="flex gap-2 ${admin?'':'hidden'} need-admin">
              <button data-action='approve' data-id='${it.id}' class='px-3 py-1.5 rounded bg-green-600 text-white text-sm'>ìŠ¹ì¸</button>
              <button data-action='reject'  data-id='${it.id}' class='px-3 py-1.5 rounded bg-rose-600 text-white text-sm'>ì‚­ì œ</button>
            </div>` : ''}
        </div>
        <div class="flex items-center gap-2 text-sm">
          <div class="text-slate-700">ë³´ê´€ ì¥ì†Œ:</div>
          <div class="flex-1">
            <input class="w-full border rounded-lg px-2 py-1.5 admin-storage" data-id='${it.id}' value='${it.storagePlace||''}' placeholder="ì˜ˆ: í•™ìƒìƒí™œê³¼ 1ì¸µ ë³´ê´€í•¨ A-3" ${admin?'':'disabled'}/>
          </div>
          <button class="px-3 py-1.5 rounded bg-slate-800 text-white text-sm btn-storage-save ${admin?'':'hidden'} need-admin" data-id='${it.id}'>ì €ì¥</button>
        </div>`;
      return li;
    };

    pending.forEach(it=> pendingList.appendChild(mkRow(it, true)));
    approved.forEach(it=> approvedList.appendChild(mkRow(it, false)));

    pendingList.querySelectorAll('button[data-action]').forEach(btn=>btn.addEventListener('click', async ()=>{
      if (!(ME && ME.isAdmin)) return alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
      const id=Number(btn.getAttribute('data-id'));
      const act=btn.getAttribute('data-action');
      
      try {
        if (act === 'approve') {
          const res = await fetch(`/api/items/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ status: 'approved' })
          });
          if (!res.ok) throw new Error('ìŠ¹ì¸ ì‹¤íŒ¨');
        } else if (act === 'reject') {
          const res = await fetch(`/api/items/${id}`, {
            method: 'DELETE',
            credentials: 'same-origin'
          });
          if (!res.ok) throw new Error('ì‚­ì œ ì‹¤íŒ¨');
        }
        
        await refreshItems();
        await renderAdminLists();
        await renderBrowse();
      } catch (err) {
        alert(err.message || 'ì‘ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }));
    [...pendingList.querySelectorAll('.btn-storage-save'), ...approvedList.querySelectorAll('.btn-storage-save')].forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        if (!(ME && ME.isAdmin)) return alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
        const id=Number(btn.getAttribute('data-id'));
        const input=btn.parentElement?.querySelector('.admin-storage');
        const storagePlace = input?.value?.trim() || '';
        
        try {
          const res = await fetch(`/api/items/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ storagePlace })
          });
          if (!res.ok) throw new Error('ì €ì¥ ì‹¤íŒ¨');
          
          await refreshItems();
          await renderAdminLists();
          await renderBrowse();
        } catch (err) {
          alert(err.message || 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      });
    });
  }

  // ===== ì±„íŒ… (Socket.IO) =====
  const socketScript = document.createElement('script'); socketScript.src='/socket.io/socket.io.js'; document.head.appendChild(socketScript);
  let socket=null, currentThreadId=null;
  function setConnBadge(state){
    const el=$('chatConn'); if(!el) return;
    if(state==='connected'){ el.textContent='ì—°ê²°ë¨'; el.className='px-2 py-0.5 rounded bg-green-100 text-green-700'; }
    else if(state==='reconnecting'){ el.textContent='ì¬ì—°ê²° ì¤‘â€¦'; el.className='px-2 py-0.5 rounded bg-amber-100 text-amber-700'; }
    else { el.textContent='ì—°ê²° ëŒ€ê¸°'; el.className='px-2 py-0.5 rounded bg-slate-200'; }
  }
  function setThreadConnBadge(state){
    const el=$('threadConn'); if(!el) return;
    if(state==='connected'){ el.textContent='ì—°ê²°ë¨'; el.className='inline-block text-xs px-2 py-0.5 rounded bg-green-100 text-green-700'; }
    else if(state==='reconnecting'){ el.textContent='ì¬ì—°ê²° ì¤‘â€¦'; el.className='inline-block text-xs px-2 py-0.5 rounded bg-amber-100 text-amber-700'; }
    else { el.textContent='ì—°ê²° ëŒ€ê¸°'; el.className='inline-block text-xs px-2 py-0.5 rounded bg-slate-200'; }
  }
  function appendChatRow({nick,text,ts}){ const wrap=$('chatLog'); if(!wrap) return; const row=document.createElement('div'); row.className='border rounded-xl px-3 py-2'; row.innerHTML=`<div class='text-sm font-medium'>${nick||'ìµëª…'}</div><div class='text-sm whitespace-pre-wrap'>${(text||'').slice(0,2000)}</div><div class='text-[10px] text-slate-500 mt-1'>${new Date(ts).toLocaleString()}</div>`; wrap.appendChild(row); wrap.scrollTop=wrap.scrollHeight; }
  function appendThreadRow({nick,text,ts}){ const wrap=$('threadLog'); if(!wrap) return; const row=document.createElement('div'); row.className='border rounded-xl px-3 py-2'; row.innerHTML=`<div class='text-sm font-medium'>${nick||'ìµëª…'}</div><div class='text-sm whitespace-pre-wrap'>${(text||'').slice(0,2000)}</div><div class='text-[10px] text-slate-500 mt-1'>${new Date(ts).toLocaleString()}</div>`; wrap.appendChild(row); wrap.scrollTop=wrap.scrollHeight; }
  function initChat(){
    if (window.io===undefined){ socketScript.onload = initChat; return; }
    // ì´ë¯¸ ì´ˆê¸°í™”ë˜ì—ˆìœ¼ë©´ ë‹¤ì‹œ ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ
    if (socket && socket.connected) return;
    socket = io({ withCredentials:false });
    socket.on('connect', ()=>{ setConnBadge('connected'); setThreadConnBadge('connected'); socket.emit('chat:join', { nick: $('chatNick')?.value?.trim()|| (ME?.name||'ìµëª…') }); });
    socket.io.on('reconnect_attempt', ()=>{ setConnBadge('reconnecting'); setThreadConnBadge('reconnecting'); });
    socket.on('disconnect', ()=>{ setConnBadge('disconnected'); setThreadConnBadge('disconnected'); });
    socket.on('chat:history', (msgs=[])=>{ const wrap=$('chatLog'); if(wrap){ wrap.innerHTML=''; msgs.forEach(appendChatRow); } });
    socket.on('chat:new', (msg)=> appendChatRow(msg));
    socket.on('thread:history', ({itemId, msgs=[]})=>{ 
      if(itemId!==currentThreadId) return; 
      const log=$('threadLog'); 
      if(!log) return; 
      log.innerHTML=''; 
      msgs.forEach(appendThreadRow); 
    });
    socket.on('thread:new', ({itemId, msg})=>{ 
      // ê°œë°œ ëª¨ë“œì—ì„œë§Œ ë””ë²„ê¹… ë¡œê·¸ ì¶œë ¥
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        console.log('ğŸ“¨ ìŠ¤ë ˆë“œ ë©”ì‹œì§€ ìˆ˜ì‹ :', {itemId, currentThreadId, msg});
      }
      if(itemId!==currentThreadId) {
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          console.log('âš ï¸ ë‹¤ë¥¸ ìŠ¤ë ˆë“œ ë©”ì‹œì§€ ë¬´ì‹œ:', itemId, '!==', currentThreadId);
        }
        return;
      }
      appendThreadRow(msg); 
    });
    $('btnSend').addEventListener('click', ()=>{
      if (!socket?.connected) return;
      const nick = $('chatNick').value.trim() || (ME?.name||'ìµëª…');
      const text = $('chatMsg').value.trim(); if(!text) return;
      socket.emit('chat:send', { nick, text, ts: new Date().toISOString() }); $('chatMsg').value='';
    });
    $('chatMsg').addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); $('btnSend').click(); } });
  }
  function joinThread(itemId){
    if (!socket || !socket.connected){ 
      console.warn('Socketì´ ì—°ê²°ë˜ì§€ ì•Šì•„ ìŠ¤ë ˆë“œì— ì°¸ì—¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return; 
    }
    if (currentThreadId) socket.emit('thread:leave', { itemId: currentThreadId });
    currentThreadId = itemId;
    socket.emit('thread:join', { itemId, nick: $('threadNick')?.value?.trim()|| (ME?.name||'ìµëª…') });
  }

  // ===== íƒ­ ì „í™˜ =====
  function switchTab(tab){
    ['tabRegister','tabBrowse','tabAdmin','tabChat'].forEach(id=> $(id).classList.add('hidden'));
    $(tab).classList.remove('hidden');
    document.querySelectorAll('header nav button').forEach(b=> b.classList.replace('bg-indigo-600','bg-slate-200'));
    const btnIdMap={tabRegister:'tabRegisterBtn', tabBrowse:'tabBrowseBtn', tabAdmin:'tabAdminBtn', tabChat:'tabChatBtn'};
    const btnEl=$(btnIdMap[tab]); if (btnEl) btnEl.classList.replace('bg-slate-200','bg-indigo-600');
    if (tab==='tabRegister'){ if (!mapRegister) initRegisterMap(); setTimeout(()=> mapRegister?.invalidateSize(), 0); }
    if (tab==='tabBrowse'){   if (!mapBrowse)   initBrowseMap();   setTimeout(()=> mapBrowse?.invalidateSize(),   0); }
  }

  // ===== ì‹œì‘ =====
  function start(){
    window.addEventListener('error', (e)=>{
      const msg=document.createElement('div'); msg.className='fixed bottom-4 left-4 bg-rose-50 text-rose-700 border border-rose-200 rounded-lg px-3 py-2 shadow z-50 text-xs'; msg.textContent='ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜: '+(e.message||''); document.body.appendChild(msg); setTimeout(()=> msg.remove(), 3500);
    });

    // íƒ­
    $('tabRegisterBtn').addEventListener('click', ()=> switchTab('tabRegister'));
    $('tabBrowseBtn').addEventListener('click',   ()=> switchTab('tabBrowse'));
    $('tabAdminBtn').addEventListener('click',    ()=> switchTab('tabAdmin'));
    $('tabChatBtn').addEventListener('click',     ()=> switchTab('tabChat'));

    // ì§€ë„ + í¼
    initRegisterMap();
    bindRegisterForm();
    initBrowseMap();

    // ê²€ìƒ‰/ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸°
    $('btnSearch').addEventListener('click', ()=> renderBrowse());
    $('btnExport').addEventListener('click', async ()=>{
      const items = await loadItems();
      const data=JSON.stringify(items, null, 2);
      const blob=new Blob([data], {type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='lost_items_backup.json'; a.click(); URL.revokeObjectURL(url);
    });
    $('inImport').addEventListener('change', async (e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      try{ 
        const text=await f.text(); 
        const arr=JSON.parse(text); 
        if(!Array.isArray(arr)) throw new Error('í˜•ì‹ ì˜¤ë¥˜');
        
        // ê° í•­ëª©ì„ APIë¥¼ í†µí•´ ë“±ë¡
        for (const item of arr) {
          try {
            await fetch('/api/items', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'same-origin',
              body: JSON.stringify({
                title: item.title,
                desc: item.desc || item.description,
                cat: item.cat || item.category,
                imgData: item.imgData,
                lat: item.lat,
                lng: item.lng,
                radius: item.radius || 0,
                storagePlace: item.storagePlace
              })
            });
          } catch (err) {
            console.error('í•­ëª© ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', item, err);
          }
        }
        
        await refreshItems();
        alert('ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ'); 
        await renderBrowse(); 
        await renderAdminLists();
      }catch(err){ alert('JSON íŒŒì‹± ì‹¤íŒ¨: '+(err.message||err)); }
    });

    // ë“œë¡œì–´ ë‹«ê¸° + ë°±ë“œë¡­
    const closeDrawer=()=>{ $('itemDrawer').classList.add('hidden'); $('drawerBackdrop').classList.add('hidden'); };
    $('btnCloseDrawer').addEventListener('click', closeDrawer);
    $('drawerBackdrop').addEventListener('click', closeDrawer);

    // ì±„íŒ…
    initChat();

    // ì¸ì¦ ìƒíƒœ â†’ UI ë°˜ì˜ í›„ ê¸°ë³¸ íƒ­
    fetchMe().then(()=> switchTab('tabRegister'));
  }

  window.addEventListener('DOMContentLoaded', ()=>{
    let tries=0; const t=setInterval(()=>{
      if (window.L){ clearInterval(t); start(); }
      else if (++tries>50){ clearInterval(t); alert('Leaflet ë¡œë”© ì‹¤íŒ¨: ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.'); }
    }, 60);
  });
  </script>
</body>
</html>