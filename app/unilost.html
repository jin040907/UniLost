<!DOCTYPE html>
<!--
  Copyright 2025 UniLost Contributors

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UniLost - Campus Lost & Found Management</title>

  <!-- Tailwind with fallback -->
  <script src="https://cdn.tailwindcss.com" 
          onerror="(function(){var s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/tailwindcss@3/dist/tailwind.min.js';document.head.appendChild(s);}())"></script>
  <script>
    // Wait for Tailwind to load before configuring
    function initTailwind() {
      if (typeof tailwind !== 'undefined') {
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                primary: {
                  50: '#eff6ff',
                  100: '#dbeafe',
                  200: '#bfdbfe',
                  300: '#93c5fd',
                  400: '#60a5fa',
                  500: '#3b82f6',
                  600: '#2563eb',
                  700: '#1d4ed8',
                  800: '#1e40af',
                  900: '#1e3a8a',
                },
                accent: {
                  50: '#f0fdf4',
                  100: '#dcfce7',
                  200: '#bbf7d0',
                  300: '#86efac',
                  400: '#4ade80',
                  500: '#22c55e',
                  600: '#16a34a',
                  700: '#15803d',
                  800: '#166534',
                  900: '#14532d',
                }
              }
            }
          }
        };
      } else {
        setTimeout(initTailwind, 100);
      }
    }
    initTailwind();
  </script>

  <!-- Leaflet CSS with fallback -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"
        onerror="(function(){var l=document.createElement('link');l.rel='stylesheet';l.href='https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css';l.crossOrigin='anonymous';document.head.appendChild(l);}())">
  
  <!-- Leaflet JS with multiple fallbacks -->
  <script>
    (function() {
      var loaded = false;
      function loadLeaflet(src) {
        if (loaded) return;
        var s = document.createElement('script');
        s.defer = true;
        s.crossOrigin = 'anonymous';
        s.src = src;
        s.onload = function() { loaded = true; };
        s.onerror = function() {
          if (src.includes('unpkg.com')) {
            loadLeaflet('https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js');
          } else if (src.includes('jsdelivr.net')) {
            loadLeaflet('https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js');
          } else {
            console.warn('All Leaflet CDN sources failed. Maps will not work.');
            loaded = true; // Stop retrying
          }
        };
        document.head.appendChild(s);
      }
      loadLeaflet('https://unpkg.com/leaflet@1.9.4/dist/leaflet.js');
    })();
  </script>

  <style>
    html, body { height: 100%; }
    body { margin: 0; }
    #mapRegister { height: 50vh; min-height: 250px; width: 100%; }
    #mapBrowse   { height: 45vh; min-height: 250px; width: 100%; }
    @media (min-width: 640px) {
      #mapRegister { height: 70vh; min-height: 320px; }
      #mapBrowse   { height: 60vh; min-height: 300px; }
    }
    .u-ellipsis  { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    @media (max-width: 639px) {
      .u-ellipsis {
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
        word-break: break-word;
      }
    }
    /* Drawer always above map */
    .leaflet-container { z-index: 0; }
    
    /* Custom styles */
    .btn-primary {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      background-color: #2563eb;
      color: white;
      font-weight: 500;
      transition: all 0.2s;
    }
    .btn-primary:hover {
      background-color: #1d4ed8;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .btn-primary:active {
      transform: scale(0.95);
    }
    .btn-secondary {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      background-color: #e2e8f0;
      color: #334155;
      font-weight: 500;
      transition: all 0.2s;
    }
    .btn-secondary:hover {
      background-color: #cbd5e1;
    }
    .btn-secondary:active {
      transform: scale(0.95);
    }
    .btn-success {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      background-color: #16a34a;
      color: white;
      font-weight: 500;
      transition: all 0.2s;
    }
    .btn-success:hover {
      background-color: #15803d;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .btn-success:active {
      transform: scale(0.95);
    }
    .input-field {
      width: 100%;
      max-width: 100%;
      border: 1px solid #cbd5e1;
      border-radius: 0.5rem;
      padding: 0.625rem 0.75rem;
      transition: all 0.2s;
      box-sizing: border-box;
      font-size: 0.875rem;
    }
    @media (min-width: 640px) {
      .input-field {
        padding: 0.625rem 1rem;
        font-size: 1rem;
      }
    }
    .input-field:focus {
      outline: none;
      border-color: transparent;
      box-shadow: 0 0 0 2px #3b82f6;
    }
    .card {
      background-color: white;
      border-radius: 0.75rem;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      border: 1px solid #e2e8f0;
      padding: 0.75rem;
      transition: box-shadow 0.2s;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      overflow-wrap: break-word;
      word-wrap: break-word;
    }
    @media (min-width: 640px) {
      .card {
        padding: 1.5rem;
      }
    }
    .card:hover {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    /* Mobile menu styles */
    #mobileMenu {
      display: none;
    }
    #mobileMenuOverlay {
      display: none !important;
    }
    @media (max-width: 767px) {
      #desktopNav {
        display: none;
      }
      #mobileMenuBtn {
        display: block;
      }
      #mobileMenu {
        display: block;
      }
      /* Overlay should only be shown when menu is open, controlled by JavaScript */
      #mobileMenuOverlay.hidden {
        display: none !important;
      }
      #mobileMenuOverlay:not(.hidden) {
        display: block !important;
      }
    }
    @media (min-width: 768px) {
      #mobileMenuBtn {
        display: none;
      }
      #mobileMenu {
        display: none !important;
      }
      #mobileMenuOverlay {
        display: none !important;
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50/30 to-slate-50 text-slate-800 min-h-screen">
  <header class="sticky top-0 z-20 bg-white/95 backdrop-blur-md border-b border-slate-200/80 shadow-sm">
    <div class="max-w-7xl mx-auto px-3 sm:px-4 py-3 sm:py-4 flex items-center gap-2 sm:gap-3">
      <div class="text-lg sm:text-xl font-bold bg-gradient-to-r from-primary-600 to-primary-800 bg-clip-text text-transparent flex items-center gap-1 sm:gap-2 flex-shrink-0">
        <span class="text-xl sm:text-2xl">ðŸŽ’</span>
        <span>UniLost</span>
        <span class="hidden md:inline text-sm font-normal text-slate-600 ml-1">Campus Lost & Found Management</span>
      </div>
      <div id="authStatus" class="hidden sm:block ml-2 text-xs sm:text-sm text-slate-600 truncate"></div>
      <nav id="desktopNav" class="ml-auto hidden md:flex gap-2 items-center">
        <button id="tabRegisterBtn" class="px-3 sm:px-4 py-2 rounded-lg bg-primary-600 text-white text-sm sm:text-base font-medium shadow-sm hover:bg-primary-700 hover:shadow-md transition-all duration-200 whitespace-nowrap">Register Item</button>
        <button id="tabBrowseBtn"   class="px-3 sm:px-4 py-2 rounded-lg bg-slate-100 text-slate-700 text-sm sm:text-base font-medium hover:bg-slate-200 transition-all duration-200 whitespace-nowrap">Search/Map</button>
        <button id="tabAdminBtn"    class="px-3 sm:px-4 py-2 rounded-lg bg-slate-100 text-slate-700 text-sm sm:text-base font-medium hover:bg-slate-200 transition-all duration-200 whitespace-nowrap">Admin</button>
        <button id="tabChatBtn"     class="px-3 sm:px-4 py-2 rounded-lg bg-slate-100 text-slate-700 text-sm sm:text-base font-medium hover:bg-slate-200 transition-all duration-200 whitespace-nowrap">Chat</button>
        <button id="btnLoginToggle" class="px-3 sm:px-4 py-2 rounded-lg bg-primary-600 text-white text-sm sm:text-base font-medium hover:bg-primary-700 shadow-sm hover:shadow-md transition-all duration-200 whitespace-nowrap">Login</button>
      </nav>
      <div class="ml-auto md:hidden flex items-center gap-2">
        <div id="authStatusMobile" class="text-xs text-slate-600 truncate max-w-[80px]"></div>
        <button id="mobileMenuBtn" class="p-2 rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 transition-all duration-200">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- Mobile Menu Overlay -->
  <div id="mobileMenuOverlay" class="fixed inset-0 bg-black/50 z-30 hidden"></div>

  <!-- Mobile Menu Drawer -->
  <div id="mobileMenu" class="fixed top-0 right-0 h-full w-64 bg-white shadow-2xl z-40 transform translate-x-full transition-transform duration-300">
    <div class="flex flex-col h-full">
      <div class="flex items-center justify-between p-4 border-b border-slate-200">
        <div class="text-lg font-bold bg-gradient-to-r from-primary-600 to-primary-800 bg-clip-text text-transparent">Menu</div>
        <button id="mobileMenuClose" class="p-2 rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 transition-all duration-200">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="flex-1 overflow-y-auto p-4 space-y-2">
        <div id="authStatusMobileMenu" class="px-3 py-2 text-sm text-slate-600 border-b border-slate-200 mb-2"></div>
        <button id="mobileTabRegisterBtn" class="w-full px-4 py-3 rounded-lg bg-primary-600 text-white font-medium shadow-sm hover:bg-primary-700 transition-all duration-200 text-left">Register Item</button>
        <button id="mobileTabBrowseBtn"   class="w-full px-4 py-3 rounded-lg bg-slate-100 text-slate-700 font-medium hover:bg-slate-200 transition-all duration-200 text-left">Search/Map</button>
        <button id="mobileTabAdminBtn"    class="w-full px-4 py-3 rounded-lg bg-slate-100 text-slate-700 font-medium hover:bg-slate-200 transition-all duration-200 text-left">Admin</button>
        <button id="mobileTabChatBtn"     class="w-full px-4 py-3 rounded-lg bg-slate-100 text-slate-700 font-medium hover:bg-slate-200 transition-all duration-200 text-left">Chat</button>
        <button id="mobileBtnLoginToggle" class="w-full px-4 py-3 rounded-lg bg-primary-600 text-white font-medium hover:bg-primary-700 shadow-sm transition-all duration-200 text-left mt-4">Login</button>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 hidden flex items-center justify-center bg-blue-900/30 backdrop-blur-sm z-50">
    <div class="bg-white w-96 p-8 rounded-2xl shadow-2xl border-2 border-primary-200">
      <h2 class="text-2xl font-bold mb-2 text-center bg-gradient-to-r from-primary-600 to-primary-800 bg-clip-text text-transparent">Login</h2>
      <p class="text-sm text-slate-500 text-center mb-6">Login to UniLost to register lost items</p>
      <div class="space-y-4">
        <input id="loginId" class="input-field" placeholder="Username (e.g., student1~10 / admin1~10)" />
        <input id="loginPw" type="password" class="input-field" placeholder="Password (e.g., 1234 / admin123)" />
      </div>
      <div class="flex justify-end gap-3 mt-6">
        <button id="btnCancelLogin" class="px-4 py-2 rounded-lg bg-slate-100 text-slate-700 font-medium hover:bg-slate-200 transition-all duration-200">Cancel</button>
        <button id="btnDoLogin" class="px-4 py-2 rounded-lg bg-primary-600 text-white font-medium hover:bg-primary-700 shadow-sm hover:shadow-md transition-all duration-200">Login</button>
      </div>
    </div>
  </div>

  <!-- Drawer Backdrop (darken map) -->
  <div id="drawerBackdrop" class="fixed inset-0 bg-black/30 hidden z-[1100]"></div>

  <main class="max-w-7xl mx-auto px-2 sm:px-4 py-3 sm:py-8 space-y-3 sm:space-y-8 w-full overflow-x-hidden">
    <!-- Register Item -->
    <section id="tabRegister" class="grid md:grid-cols-2 gap-3 sm:gap-6 w-full">
      <div class="card space-y-4 sm:space-y-5 w-full max-w-full">
        <div class="min-w-0">
          <h2 class="text-xl sm:text-2xl font-bold text-slate-900 mb-1 break-words">Register Item</h2>
          <p class="text-xs sm:text-sm text-slate-500 break-words">Register lost or found items</p>
        </div>

        <div class="grid gap-3">
          <label class="text-sm font-medium text-slate-700">Upload Photo</label>
          <label for="inImage" class="block w-full text-sm cursor-pointer">
            <span class="inline-block px-4 py-2 rounded-lg bg-primary-50 text-primary-700 font-medium hover:bg-primary-100 transition-colors">Choose File</span>
            <span id="fileName" class="ml-3 text-slate-600">No file chosen</span>
            <input id="inImage" type="file" accept="image/*" class="hidden" />
          </label>
          <img id="preview" class="mt-2 max-h-48 rounded-xl hidden shadow-sm border border-slate-200" alt="Preview" />
        </div>

        <div class="grid gap-3">
          <label class="text-sm font-medium text-slate-700">Item Name/Description</label>
          <input id="inTitle" class="input-field" placeholder="e.g., Black wallet, Blue umbrella, AirPods case" />
          <textarea id="inDesc" rows="3" class="input-field" placeholder="Detailed description (color, brand, features, found/lost situation)"></textarea>
          <div class="text-xs text-slate-500">â€» Items are automatically classified based on description. Manual changes available if needed.</div>
        </div>

        <div class="grid gap-2">
          <label class="text-sm font-medium text-slate-700">Auto Classification Result</label>
          <div class="flex flex-col sm:flex-row gap-2">
            <input id="inCategory" class="flex-1 input-field" placeholder="Waiting for auto classificationâ€¦" />
            <button id="btnClassify" class="px-3 sm:px-4 py-2 rounded-lg bg-primary-600 text-white text-sm sm:text-base font-medium hover:bg-primary-700 shadow-sm hover:shadow-lg hover:shadow-primary-500/25 transition-all duration-200 whitespace-nowrap">Auto Classify</button>
          </div>
        </div>

        <div class="grid gap-2">
          <label class="text-sm font-medium text-slate-700">Location (Address)</label>
          <div class="flex flex-col sm:flex-row gap-2">
            <input id="inAddress" class="flex-1 input-field" placeholder="e.g., Sejong University, Building Name, Address" />
            <button id="btnGeocode" class="px-3 sm:px-4 py-2 rounded-lg bg-primary-600 text-white text-sm sm:text-base font-medium hover:bg-primary-700 shadow-sm hover:shadow-lg hover:shadow-primary-500/25 transition-all duration-200 whitespace-nowrap">Find Address</button>
          </div>
          <div class="text-xs text-slate-500">Or <b>click on the map</b> to set location</div>
          <div class="grid grid-cols-2 gap-2">
            <input id="inLat" class="input-field" placeholder="Latitude" />
            <input id="inLng" class="input-field" placeholder="Longitude" />
          </div>
        </div>

        <div class="flex flex-col sm:flex-row sm:items-center gap-2">
          <label class="text-sm font-medium text-slate-700">Accuracy Radius (meters)</label>
          <input id="inRadius" type="number" min="0" value="50" class="w-full sm:w-32 input-field" />
        </div>

        <!-- New: Storage place on registration -->
        <div class="grid gap-2">
          <label class="text-sm font-medium text-slate-700">Storage Place (Optional)</label>
          <input id="inStoragePlaceReg" class="input-field"
                 placeholder="e.g., Student Affairs Office, 1st Floor, Locker A-3" />
        </div>

        <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 pt-2">
          <button id="btnSubmit" class="px-4 py-2 rounded-lg bg-primary-600 text-white text-sm sm:text-base font-medium hover:bg-primary-700 shadow-sm hover:shadow-lg hover:shadow-primary-500/25 transition-all duration-200 flex-1">Submit Request</button>
          <button id="btnResetForm" class="px-4 py-2 rounded-lg bg-primary-600 text-white text-sm sm:text-base font-medium hover:bg-primary-700 shadow-sm hover:shadow-lg hover:shadow-primary-500/25 transition-all duration-200">Reset</button>
        </div>

        <p id="guardNotice" class="text-xs text-rose-600 hidden">â€» Please login to register.</p>
      </div>

      <div class="card w-full max-w-full">
        <h3 class="text-base sm:text-lg font-semibold mb-2 sm:mb-3 text-slate-900 break-words">Verify Location on Map</h3>
        <div id="mapRegister" class="rounded-xl overflow-hidden border border-slate-200 w-full"></div>
        <p class="mt-2 sm:mt-3 text-xs text-slate-500 break-words">Click <b>Find Address</b> after entering address, or click on the map to set coordinates.</p>
      </div>
    </section>

    <!-- Search/Map -->
    <section id="tabBrowse" class="hidden w-full">
      <div class="grid md:grid-cols-3 gap-3 sm:gap-6 w-full">
        <div class="md:col-span-1 card space-y-3 sm:space-y-4 w-full max-w-full">
          <div class="min-w-0">
            <h2 class="text-lg sm:text-xl font-bold text-slate-900 mb-1 break-words">Search Items</h2>
            <p class="text-xs sm:text-sm text-slate-500 break-words">Search by keyword or category</p>
          </div>
          <input id="qText" class="input-field" placeholder="Keyword (e.g., wallet, blue, AirPods)" />
          <select id="qCategory" class="input-field">
            <option value="">All Categories</option>
            <option>Wallet</option><option>Student ID/Card</option><option>Electronics</option>
            <option>Earbuds/AirPods</option><option>Laptop</option><option>Umbrella</option>
            <option>Clothing</option><option>Books/Notes</option><option>Other</option>
          </select>
          <div class="flex items-center gap-2 text-sm">
            <input id="qOnlyApproved" type="checkbox" checked class="w-4 h-4 text-primary-600 rounded focus:ring-primary-500">
            <label for="qOnlyApproved" class="text-slate-700">Approved items only</label>
          </div>
          <button id="btnSearch" class="px-4 py-2 rounded-lg bg-primary-600 text-white text-sm sm:text-base font-medium hover:bg-primary-700 shadow-sm hover:shadow-lg hover:shadow-primary-500/25 transition-all duration-200 w-full">Search</button>
          <div class="text-xs text-slate-500">Click an item in the list to focus map & open drawer.</div>
          <hr class="my-2 border-slate-200" />
          <div class="flex flex-col sm:flex-row gap-2">
            <button id="btnExport" class="px-3 sm:px-4 py-2 rounded-lg bg-primary-600 text-white text-xs sm:text-sm font-medium hover:bg-primary-700 shadow-sm hover:shadow-lg hover:shadow-primary-500/25 transition-all duration-200 flex-1">Export JSON</button>
            <label class="px-3 sm:px-4 py-2 rounded-lg bg-primary-600 text-white text-xs sm:text-sm font-medium hover:bg-primary-700 shadow-sm hover:shadow-lg hover:shadow-primary-500/25 transition-all duration-200 flex-1 text-center cursor-pointer">
              Import JSON<input id="inImport" type="file" accept="application/json" class="hidden" />
            </label>
          </div>
        </div>

        <div class="md:col-span-2 card relative w-full max-w-full">
          <h3 class="text-base sm:text-lg font-semibold mb-2 sm:mb-3 text-slate-900 break-words">Map & List</h3>
          <div id="mapBrowse" class="rounded-xl overflow-hidden border border-slate-200 w-full"></div>
          <ul id="listResults" class="mt-3 sm:mt-4 divide-y divide-slate-200 w-full"></ul>
        </div>
      </div>

      <!-- Item Detail + Thread Chat Drawer (always read-only) -->
      <div id="itemDrawer" class="fixed inset-y-0 right-0 w-full sm:w-[480px] bg-white shadow-2xl border-l border-slate-200 hidden z-[1200]">
        <div class="h-full flex flex-col">
          <div class="flex items-center gap-2 px-4 py-4 border-b border-slate-200 bg-gradient-to-r from-primary-50 to-white">
            <button id="btnCloseDrawer" class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 transition-all duration-200">Close</button>
            <div id="drawerTitle" class="ml-2 font-semibold truncate text-slate-900">Item</div>
          </div>
          <div class="p-5 space-y-4 overflow-auto">
            <img id="drawerImg" class="w-full max-h-48 object-cover rounded-xl bg-slate-100 hidden shadow-sm" alt="">
            <div class="text-sm text-slate-600"><span id="drawerMeta"></span></div>
            <div class="text-sm whitespace-pre-wrap text-slate-700" id="drawerDesc"></div>
            <div class="text-sm">
              <div class="font-semibold text-slate-900 mb-1">Storage Place</div>
              <div id="drawerStorageView" class="text-slate-700"></div>
              <!-- Always read-only in drawer -->
              <div id="drawerStorageEdit" class="hidden mt-2 gap-2 sm:flex">
                <input id="inStoragePlace" class="flex-1 input-field" />
                <button id="btnSaveStorage" class="px-4 py-2 rounded-lg bg-primary-600 text-white font-medium hover:bg-primary-700 shadow-sm hover:shadow-lg hover:shadow-primary-500/25 transition-all duration-200 whitespace-nowrap">Save</button>
              </div>
            </div>
            <hr class="border-slate-200"/>
            <div>
              <div class="font-semibold text-slate-900 mb-2">Thread Chat</div>
              <div id="threadConn" class="inline-block text-xs px-2 py-1 rounded-lg bg-slate-100 text-slate-600 mt-1">Connecting...</div>
              <div id="threadLog" class="h-64 mt-3 border border-slate-200 rounded-xl p-3 overflow-auto space-y-2 bg-slate-50"></div>
              <div class="mt-3 flex gap-2">
                <input id="threadNick" class="w-32 input-field" placeholder="Nickname" />
                <input id="threadMsg" class="flex-1 input-field" placeholder="Message (Enter to send)" />
                <button id="btnThreadSend" class="px-4 py-2 rounded-lg bg-primary-600 text-white font-medium hover:bg-primary-700 shadow-sm hover:shadow-lg hover:shadow-primary-500/25 transition-all duration-200 whitespace-nowrap">Send</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Admin -->
    <section id="tabAdmin" class="hidden w-full">
      <div class="card w-full max-w-full">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-2 mb-3 sm:mb-6">
          <div class="min-w-0 flex-1">
            <h2 class="text-lg sm:text-2xl font-bold text-slate-900 mb-1 break-words">Admin Approval</h2>
            <p class="text-xs sm:text-sm text-slate-500 break-words">Review and approve item registration requests</p>
          </div>
          <div class="flex flex-col sm:flex-row gap-1.5 sm:gap-2 items-start sm:items-center text-xs sm:text-sm flex-shrink-0">
            <span class="text-slate-600 whitespace-nowrap">Admin login required</span>
            <span id="adminStatus" class="text-xs px-2 py-1 rounded-lg bg-slate-100 text-slate-600 whitespace-nowrap">No permission</span>
          </div>
        </div>
        <div class="grid md:grid-cols-2 gap-3 sm:gap-6">
          <div class="min-w-0">
            <h3 class="font-semibold mb-2 sm:mb-3 text-slate-900 text-sm sm:text-lg">Pending (Unapproved)</h3>
            <ul id="pendingList" class="divide-y divide-slate-200 space-y-2"></ul>
          </div>
          <div class="min-w-0">
            <h3 class="font-semibold mb-2 sm:mb-3 text-slate-900 text-sm sm:text-lg">Approved</h3>
            <ul id="approvedList" class="divide-y divide-slate-200 space-y-2"></ul>
          </div>
        </div>
      </div>
    </section>

    <!-- Global Chat -->
    <section id="tabChat" class="hidden w-full">
      <div class="grid md:grid-cols-3 gap-3 sm:gap-6 w-full">
        <div class="md:col-span-1 card space-y-3 sm:space-y-4 w-full max-w-full">
          <div class="min-w-0">
            <h2 class="text-lg sm:text-xl font-bold text-slate-900 mb-1 break-words">Student/Admin Chat</h2>
            <p class="text-xs sm:text-sm text-slate-500 break-words">Communicate with all users in real-time</p>
          </div>
          <input id="chatNick" class="input-field text-sm" placeholder="Nickname (anonymous if empty)" />
          <textarea id="chatMsg" rows="3" class="input-field text-sm" placeholder="Message"></textarea>
          <button id="btnSend" class="px-4 py-2 rounded-lg bg-primary-600 text-white text-sm sm:text-base font-medium hover:bg-primary-700 shadow-sm hover:shadow-lg hover:shadow-primary-500/25 transition-all duration-200 w-full">Send (Enter)</button>
          <div class="text-xs"><span id="chatConn" class="px-2 py-1 rounded-lg bg-slate-100 text-slate-600">Connecting...</span></div>
        </div>
        <div class="md:col-span-2 card w-full max-w-full">
          <h3 class="text-base sm:text-lg font-semibold mb-2 sm:mb-3 text-slate-900 break-words">Chat Log</h3>
          <div id="chatLog" class="h-[50vh] sm:h-[60vh] overflow-auto space-y-2 border border-slate-200 rounded-xl p-3 sm:p-4 bg-slate-50 w-full flex flex-col-reverse"></div>
        </div>
      </div>
    </section>
  </main>

  <footer class="max-w-7xl mx-auto px-4 py-8 text-xs text-center text-slate-500 border-t border-slate-200 mt-12">
    <p>Data is stored in <b class="text-slate-700">PostgreSQL/SQLite database</b>. Data is preserved after server restart.</p>
    <p class="mt-2">Â© 2025 UniLost Contributors - Apache License 2.0</p>
  </footer>

  <script>
  // ===== Common State/Utils =====
  const defaultLat = 37.5519, defaultLng = 127.0732; // Near Sejong University
  const $ = (id) => {
    const el = document.getElementById(id);
    if (!el) {
      console.warn('Element not found:', id);
    }
    return el;
  };
  let itemsCache = []; // Item cache
  const STORE_KEY = 'lostItems_v2'; // No longer used but kept for compatibility
  
  // Load items via API
  async function loadItems() {
    try {
      const res = await fetch('/api/items', { credentials: 'same-origin' });
      if (!res.ok) throw new Error('Failed to load items');
      itemsCache = await res.json();
      return itemsCache;
    } catch (err) {
      console.error('Item load error:', err);
      return itemsCache; // Return cached data
    }
  }
  
  // Refresh items (update cache)
  async function refreshItems() {
    itemsCache = await loadItems();
    return itemsCache;
  }
  const RULES = [
    { kw: [/airpod|earbuds|earphones|buds|galaxy buds/i], cat:'Earbuds/AirPods' }, { kw:[/wallet|card wallet/i],cat:'Wallet' },
    { kw: [/student id|id card|card|student number|student card/i],cat:'Student ID/Card' }, { kw:[/laptop|macbook|gram|notebook/i],cat:'Laptop' },
    { kw: [/ipad|tablet/i],cat:'Electronics' }, { kw:[/phone|smartphone|mobile|iphone|galaxy|cellphone|cell phone/i],cat:'Electronics' },
    { kw: [/umbrella/i],cat:'Umbrella' }, { kw:[/hood|coat|clothing|jacket|jumper|padded|shirt|pants|jeans/i],cat:'Clothing' }, { kw:[/book|textbook|note|notebook|notepad/i],cat:'Books/Notes' },
  ];
  const autoClassify = (t='') => { const s=t.toLowerCase(); for (const r of RULES) if (r.kw.some(rx=>rx.test(s))) return r.cat; return 'Other'; };

  // ===== Authentication State =====
  let ME = null;  // {id, name, isAdmin} | null

  async function fetchMe(){
    const res = await fetch('/api/me', { credentials: 'same-origin' });
    const { user } = await res.json();
    ME = user || null;
    updateAuthUI();
  }
  async function doLogin(id, pw){
    const res = await fetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ id, pw })
    });
    if (!res.ok){
      const e = await res.json().catch(()=>({error:'Login failed'}));
      throw new Error(e.error||'Login failed');
    }
    ME = (await res.json()).user;
    updateAuthUI();
  }
  async function doLogout(){
    await fetch('/api/logout', { method:'POST', credentials: 'same-origin' });
    ME = null; updateAuthUI();
  }

  async function updateAuthUI(){
    const s = $('authStatus');
    if (s) s.textContent = ME ? `Hello, ${ME.name}` : 'Not logged in';
    const sMobile = $('authStatusMobile');
    if (sMobile) sMobile.textContent = ME ? ME.name : '';
    const sMobileMenu = $('authStatusMobileMenu');
    if (sMobileMenu) sMobileMenu.textContent = ME ? `Hello, ${ME.name}` : 'Not logged in';
    
    const btn = $('btnLoginToggle');
    if (btn) {
      btn.textContent = ME ? 'Logout' : 'Login';
      btn.onclick = ()=> ME ? doLogout() : showLoginModal();
    }
    const btnMobile = $('mobileBtnLoginToggle');
    if (btnMobile) {
      btnMobile.textContent = ME ? 'Logout' : 'Login';
      btnMobile.onclick = ()=> { closeMobileMenu(); ME ? doLogout() : showLoginModal(); };
    }

    const canSubmit = !!ME;
    $('btnSubmit').disabled = !canSubmit;
    $('btnSubmit').classList.toggle('opacity-50', !canSubmit);
    $('guardNotice').classList.toggle('hidden', canSubmit);

    const admin = !!(ME && ME.isAdmin);
    $('adminStatus').textContent = admin ? 'Admin privileges' : 'No permission';

    await renderAdminLists();
    await renderBrowse();
  }

  function showLoginModal(){ $('loginModal').classList.remove('hidden'); }
  function hideLoginModal(){ $('loginModal').classList.add('hidden'); }
  $('btnCancelLogin').onclick = hideLoginModal;
  
  // Login function
  const performLogin = async ()=>{
    const id = $('loginId').value.trim();
    const pw = $('loginPw').value.trim();
    if (!id || !pw) return alert('Please enter username/password.');
    try { await doLogin(id, pw); hideLoginModal(); }
    catch(e){ alert(e.message||'Login failed'); }
  };
  
  $('btnDoLogin').onclick = performLogin;
  
  // Enter key support for login form
  $('loginId').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      $('loginPw').focus();
    }
  });
  
  $('loginPw').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      performLogin();
    }
  });

  // ===== Maps =====
  let mapRegister, mapBrowse, registerMarker, registerCircle, regRO, brRO;
  let browseMarkers = [];
  function initRegisterMap(){
    try {
      if (typeof L === 'undefined' || !L || !L.map) {
        console.warn('Leaflet not loaded yet, retrying...');
        setTimeout(initRegisterMap, 200);
        return;
      }
      const el = $('mapRegister'); if (!el || mapRegister) return;
      if (el.offsetParent===null || el.clientHeight===0 || el.clientWidth===0){ setTimeout(initRegisterMap,120); return; }
      // South Korea bounds: [[south, west], [north, east]]
      const koreaBounds = [[33.1, 124.6], [38.6, 131.9]];
      mapRegister = L.map('mapRegister', {
        maxBounds: koreaBounds,
        maxBoundsViscosity: 1.0,
        minZoom: 7
      });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'Â© OpenStreetMap contributors'}).addTo(mapRegister);
      setRegisterLocation(defaultLat, defaultLng, true);
      mapRegister.on('click', e=> setRegisterLocation(e.latlng.lat, e.latlng.lng, false));
      setTimeout(()=> mapRegister.invalidateSize(), 50);
      regRO = new ResizeObserver(()=> mapRegister && mapRegister.invalidateSize()); regRO.observe(el);
    } catch (err) {
      console.error('Failed to initialize register map:', err);
      // Show error message but don't block page functionality
      const el = $('mapRegister');
      if (el) {
        el.innerHTML = '<div class="p-4 text-center text-red-600">Map failed to load. Please refresh the page or check your network connection.</div>';
      }
    }
  }
  function setRegisterLocation(lat, lng, first){
    if (!mapRegister) return;
    try {
      // South Korea bounds validation
      const koreaBounds = {south: 33.1, north: 38.6, west: 124.6, east: 131.9};
      lat = Math.max(koreaBounds.south, Math.min(koreaBounds.north, lat ?? defaultLat));
      lng = Math.max(koreaBounds.west, Math.min(koreaBounds.east, lng ?? defaultLng));
      
      $('inLat').value = lat.toFixed(6);
      $('inLng').value = lng.toFixed(6);
      if (registerMarker) registerMarker.remove();
      if (registerCircle) registerCircle.remove();
      registerMarker = L.marker([lat,lng]).addTo(mapRegister).bindPopup('Registration Location');
      const r = Number($('inRadius').value||0);
      if (r>0) registerCircle = L.circle([lat,lng], {radius:r, fillOpacity:.15}).addTo(mapRegister);
      mapRegister.setView([lat,lng], first?15:16); registerMarker.openPopup();
    } catch (err) {
      console.error('Failed to set register location:', err);
    }
  }
  function initBrowseMap(){
    try {
      if (typeof L === 'undefined' || !L || !L.map) {
        console.warn('Leaflet not loaded yet, retrying...');
        setTimeout(initBrowseMap, 200);
        return;
      }
      const el = $('mapBrowse'); if (!el || mapBrowse) return;
      if (el.offsetParent===null || el.clientHeight===0 || el.clientWidth===0){ setTimeout(initBrowseMap,120); return; }
      // South Korea bounds: [[south, west], [north, east]]
      const koreaBounds = [[33.1, 124.6], [38.6, 131.9]];
      mapBrowse = L.map('mapBrowse', {
        maxBounds: koreaBounds,
        maxBoundsViscosity: 1.0,
        minZoom: 7
      });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'Â© OpenStreetMap contributors'}).addTo(mapBrowse);
      mapBrowse.setView([defaultLat, defaultLng], 15);
      renderBrowse();
      setTimeout(()=> mapBrowse.invalidateSize(), 50);
      brRO = new ResizeObserver(()=> mapBrowse && mapBrowse.invalidateSize()); brRO.observe(el);
    } catch (err) {
      console.error('Failed to initialize browse map:', err);
      // Show error message but don't block page functionality
      const el = $('mapBrowse');
      if (el) {
        el.innerHTML = '<div class="p-4 text-center text-red-600">Map failed to load. Please refresh the page or check your network connection.</div>';
      }
    }
  }
  function clearBrowseMarkers(){ 
    try {
      browseMarkers.forEach(m=>{ try { m.remove(); } catch(e) { console.warn('Failed to remove marker:', e); } }); 
      browseMarkers=[]; 
    } catch (err) {
      console.error('Failed to clear browse markers:', err);
      browseMarkers = [];
    }
  }

  // ===== Geocoding =====
  async function geocode(address){
    const url = new URL('https://nominatim.openstreetmap.org/search');
    url.search = new URLSearchParams({ q: address, format: 'json', addressdetails: 1 }).toString();
    const res = await fetch(url, { headers: { 'Accept-Language': 'ko' } });
    if (!res.ok) throw new Error('Geocoding failed');
    return res.json();
  }

  // ===== Registration Form =====
  function bindRegisterForm(){
    const inImage=$('inImage'), preview=$('preview'), inTitle=$('inTitle'), inDesc=$('inDesc'), inCategory=$('inCategory');

    inImage.addEventListener('change', ()=>{
      const f=inImage.files?.[0];
      const fileNameEl = $('fileName');
      if(!f){ 
        preview.classList.add('hidden'); 
        preview.src=''; 
        if (fileNameEl) fileNameEl.textContent = 'No file chosen';
        return; 
      }
      if (fileNameEl) fileNameEl.textContent = f.name;
      const fr=new FileReader(); fr.onload=()=>{ preview.src=fr.result; preview.classList.remove('hidden'); }; fr.readAsDataURL(f);
      if(!inCategory.value) inCategory.value = autoClassify(f.name||'');
    });
    $('btnClassify').addEventListener('click', ()=> inCategory.value = autoClassify(`${inTitle.value}\n${inDesc.value}`));
    $('btnGeocode').addEventListener('click', async ()=>{
      const q=$('inAddress').value.trim(); if(!q) return alert('Please enter an address.');
      try{
        const results=await geocode(q); if(!results.length) return alert('Address not found.');
        const {lat,lon,display_name}=results[0]; setRegisterLocation(parseFloat(lat), parseFloat(lon), false);
        if (registerMarker) registerMarker.bindPopup(`<b>Item Location</b><br>${display_name}`).openPopup();
      }catch(e){ alert(e.message||'Geocoding error'); }
    });
    $('inRadius').addEventListener('change', ()=>{
      const lat=parseFloat($('inLat').value||defaultLat), lng=parseFloat($('inLng').value||defaultLng);
      setRegisterLocation(lat,lng,false);
    });

    $('btnResetForm').addEventListener('click', ()=>{
      inImage.value=''; preview.src=''; preview.classList.add('hidden');
      inTitle.value=''; inDesc.value=''; inCategory.value=''; $('inAddress').value='';
      $('inLat').value=defaultLat; $('inLng').value=defaultLng; $('inRadius').value=50;
      const sp=$('inStoragePlaceReg'); if (sp) sp.value='';
      setRegisterLocation(defaultLat, defaultLng, true);
    });

    $('btnSubmit').addEventListener('click', async ()=>{
      if (!ME) return alert('Login required.');
      const title=inTitle.value.trim(); if(!title) return alert('Please enter item name/description.');
      const desc=inDesc.value.trim(); let cat=inCategory.value.trim(); if(!cat) cat=autoClassify(`${title}\n${desc}`);
      const lat=parseFloat($('inLat').value), lng=parseFloat($('inLng').value); const radius=Number($('inRadius').value||0);

      // Storage place on registration
      const storagePlace = ($('inStoragePlaceReg').value || '').trim();

      let imgData=''; const f=inImage.files?.[0];
      if(f){ imgData = await new Promise(r=>{ const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(f); }); }

      try {
        const res = await fetch('/api/items', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ title, desc, cat, imgData, lat, lng, radius, storagePlace })
        });
        
        if (!res.ok) {
          const err = await res.json().catch(() => ({ error: 'Registration failed' }));
          throw new Error(err.error || 'Registration failed');
        }
        
        await refreshItems();
        alert('Registration request submitted. Will be published after admin approval.');
        $('btnResetForm').click();
        renderAdminLists();
        renderBrowse();
      } catch (err) {
        alert(err.message || 'An error occurred during registration.');
      }
    });
  }

  // ===== Search/Map + Drawer =====
  async function renderBrowse(){
    if (!mapBrowse) return;
    try {
      const items = await loadItems();
      const qText=$('qText').value.trim().toLowerCase(), qCategory=$('qCategory').value, onlyApproved=$('qOnlyApproved').checked;
      const filtered=items.filter(it=>{
        if (onlyApproved && it.status!=='approved') return false;
        if (qCategory && it.cat!==qCategory) return false;
        if (qText){ const blob = `${it.title} ${it.desc} ${it.cat}`.toLowerCase(); if (!blob.includes(qText)) return false; }
        return true;
      }).sort((a,b)=>(b.created_at||'').localeCompare(a.created_at||''));

      const ul=$('listResults'); ul.innerHTML='';
      filtered.forEach(it=>{
        const li=document.createElement('li');
        li.className='py-2 flex gap-2 sm:gap-3 items-start cursor-pointer hover:bg-slate-50 px-2 rounded w-full max-w-full break-words';
        li.innerHTML=`
          <img src="${it.imgData||''}" class="w-10 h-10 sm:w-12 sm:h-12 object-cover rounded-lg bg-slate-100 ${it.imgData?'':'hidden'} flex-shrink-0" alt="">
          <div class="flex-1 min-w-0 w-full">
            <div class="font-medium text-sm sm:text-base break-words">${it.title}<span class="text-xs text-slate-500"> (${it.cat}${it.storagePlace?` Â· Storage:${it.storagePlace}`:''})</span></div>
            <div class="text-xs text-slate-500 break-words mt-0.5">${it.desc||''}</div>
            <div class="text-[10px] text-slate-400 mt-0.5 break-words">${it.status} â€¢ ${new Date(it.created_at).toLocaleString()}</div>
          </div>`;
        li.addEventListener('click', ()=>{ 
          if (mapBrowse) {
            try {
              mapBrowse.setView([it.lat,it.lng], 17);
              openItemDrawer(it.id);
            } catch (err) {
              console.error('Failed to set map view:', err);
              openItemDrawer(it.id);
            }
          } else {
            openItemDrawer(it.id);
          }
        });
        ul.appendChild(li);
      });

      clearBrowseMarkers();
      if (typeof L !== 'undefined' && L && L.marker) {
        filtered.forEach(it=>{
          try {
            const mk=L.marker([it.lat,it.lng]).addTo(mapBrowse).bindPopup(`
              <b>${it.title}</b><br/>
              <span class="text-xs">${it.cat}${it.storagePlace?` Â· Storage:${it.storagePlace}`:''} â€¢ ${new Date(it.created_at).toLocaleString()}</span><br/>
              <span class="text-xs">${(it.desc||'').replace(/[\n\r]+/g,' ')}</span>
            `);
            browseMarkers.push(mk);
            if (it.radius>0){ const circle=L.circle([it.lat,it.lng],{radius:it.radius,fillOpacity:.12}); circle.addTo(mapBrowse); browseMarkers.push(circle); }
            mk.on('click', ()=> openItemDrawer(it.id));
          } catch (err) {
            console.error('Failed to add marker for item:', it.id, err);
          }
        });
      }
    } catch (err) {
      console.error('Failed to render browse:', err);
    }
  }

  async function openItemDrawer(itemId){
    const items = await loadItems();
    const it=items.find(x=>x.id===itemId); if(!it) return;

    $('drawerBackdrop').classList.remove('hidden');
    $('itemDrawer').classList.remove('hidden');

    $('drawerTitle').textContent=`${it.title} (#${it.id})`;
    const img=$('drawerImg'); if(it.imgData){ img.src=it.imgData; img.classList.remove('hidden'); } else { img.classList.add('hidden'); }
    $('drawerMeta').textContent=`${it.cat} â€¢ ${new Date(it.created_at).toLocaleString()}`;
    $('drawerDesc').textContent=it.desc||'';
    $('drawerStorageView').textContent=it.storagePlace||'â€”';

    // Always read-only in drawer
    const editWrap=$('drawerStorageEdit'); if (editWrap) editWrap.classList.add('hidden');

    // Thread chat
    // Initialize Socket if not already initialized
    if (!socket && window.io) {
      initChat();
    }
    // Set badge based on Socket connection status
    if (socket && socket.connected) {
      setThreadConnBadge('connected');
      joinThread(it.id);
    } else {
      setThreadConnBadge('disconnected');
      // Add event listener to automatically join when Socket connects
      if (socket) {
        const onConnect = () => {
          setThreadConnBadge('connected');
          joinThread(it.id);
          socket.off('connect', onConnect);
        };
        socket.on('connect', onConnect);
      }
    }

    const sendThread=()=>{
      const text=$('threadMsg').value.trim(); if(!text) return;
      const nick=$('threadNick').value.trim() || (ME?.name||'Anonymous');
      if (!socket || !socket.connected) {
        alert('Not connected to server. Please try again later.');
        return;
      }
      socket.emit('thread:send', { itemId: it.id, nick, text, ts: new Date().toISOString() });
      $('threadMsg').value='';
      // Messages are added when receiving thread:new event from server, so don't add here
    };
    $('btnThreadSend').onclick=sendThread;
    $('threadMsg').onkeydown=(e)=>{ if(e.key==='Enter'&& !e.shiftKey){ e.preventDefault(); sendThread(); } };

    setTimeout(()=> { 
      try { 
        mapBrowse?.invalidateSize(); 
      } catch(e) { 
        console.warn('Failed to invalidate browse map size in drawer:', e); 
      } 
    }, 60);
  }

  // ===== Admin Lists =====
  async function renderAdminLists(){
    const admin = !!(ME && ME.isAdmin);
    const items = await loadItems();
    const pending=items.filter(it=>it.status!=='approved').sort((a,b)=>(a.created_at||'').localeCompare(b.created_at||'')); // Oldest first
    const approved=items.filter(it=>it.status==='approved').sort((a,b)=>(b.created_at||'').localeCompare(a.created_at||'')); // Newest first

    const pendingList=$('pendingList'), approvedList=$('approvedList');
    pendingList.innerHTML=''; approvedList.innerHTML='';

    const mkRow=(it, pendingMode)=>{
      const li=document.createElement('li');
      li.className='py-2 sm:py-3 flex flex-col gap-2 w-full max-w-full break-words';
      li.innerHTML=`
        <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 sm:items-center w-full">
          <div class="flex gap-2 sm:gap-3 items-start flex-1 min-w-0 w-full">
            <img src="${it.imgData||''}" class="w-10 h-10 sm:w-14 sm:h-14 object-cover rounded-lg bg-slate-100 ${it.imgData?'':'hidden'} flex-shrink-0" alt="">
            <div class="flex-1 min-w-0 w-full">
              <div class="font-medium text-sm sm:text-base break-words">${it.title} <span class="text-xs text-slate-500">(${it.cat})</span></div>
              <div class="text-xs text-slate-500 break-words mt-0.5">${it.desc||''}</div>
              <div class="text-[10px] text-slate-400 mt-0.5 break-words">#${it.id} â€¢ ${it.status} â€¢ ${new Date(it.created_at).toLocaleString()}</div>
            </div>
          </div>
          ${pendingMode ? `
            <div class="flex gap-1.5 sm:gap-2 ${admin?'':'hidden'} need-admin flex-shrink-0">
              <button data-action='approve' data-id='${it.id}' class='px-2 sm:px-3 py-1.5 rounded-lg bg-primary-600 text-white text-xs sm:text-sm font-medium hover:bg-primary-700 shadow-sm hover:shadow-lg hover:shadow-primary-500/25 transition-all duration-200 whitespace-nowrap'>Approve</button>
              <button data-action='reject'  data-id='${it.id}' class='px-2 sm:px-3 py-1.5 rounded-lg bg-primary-600 text-white text-xs sm:text-sm font-medium hover:bg-primary-700 shadow-sm hover:shadow-lg hover:shadow-primary-500/25 transition-all duration-200 whitespace-nowrap'>Delete</button>
            </div>` : ''}
        </div>
        <div class="flex flex-col sm:flex-row sm:items-center gap-2 text-xs sm:text-sm w-full">
          <div class="text-slate-700 font-medium whitespace-nowrap flex-shrink-0">Storage Place:</div>
          <div class="flex-1 min-w-0 w-full">
            <input class="w-full max-w-full input-field text-xs sm:text-sm py-1.5 admin-storage" data-id='${it.id}' value='${it.storagePlace||''}' placeholder="e.g., Student Affairs Office, 1st Floor, Locker A-3" ${admin?'':'disabled'}/>
          </div>
          <button class="px-2 sm:px-3 py-1.5 rounded-lg bg-primary-600 text-white text-xs sm:text-sm font-medium hover:bg-primary-700 shadow-sm hover:shadow-lg hover:shadow-primary-500/25 transition-all duration-200 btn-storage-save ${admin?'':'hidden'} need-admin whitespace-nowrap flex-shrink-0 w-full sm:w-auto" data-id='${it.id}'>Save</button>
        </div>`;
      return li;
    };

    pending.forEach(it=> pendingList.appendChild(mkRow(it, true)));
    approved.forEach(it=> approvedList.appendChild(mkRow(it, false)));

    pendingList.querySelectorAll('button[data-action]').forEach(btn=>btn.addEventListener('click', async ()=>{
      if (!(ME && ME.isAdmin)) return alert('Admin privileges required.');
      const id=Number(btn.getAttribute('data-id'));
      const act=btn.getAttribute('data-action');
      
      try {
        if (act === 'approve') {
          const res = await fetch(`/api/items/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ status: 'approved' })
          });
          if (!res.ok) throw new Error('Approval failed');
        } else if (act === 'reject') {
          const res = await fetch(`/api/items/${id}`, {
            method: 'DELETE',
            credentials: 'same-origin'
          });
          if (!res.ok) throw new Error('Deletion failed');
        }
        
        await refreshItems();
        await renderAdminLists();
        await renderBrowse();
      } catch (err) {
        alert(err.message || 'An error occurred during operation.');
      }
    }));
    [...pendingList.querySelectorAll('.btn-storage-save'), ...approvedList.querySelectorAll('.btn-storage-save')].forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        if (!(ME && ME.isAdmin)) return alert('Admin privileges required.');
        const id=Number(btn.getAttribute('data-id'));
        const input=btn.parentElement?.querySelector('.admin-storage');
        const storagePlace = input?.value?.trim() || '';
        
        try {
          const res = await fetch(`/api/items/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ storagePlace })
          });
          if (!res.ok) throw new Error('Save failed');
          
          await refreshItems();
          await renderAdminLists();
          await renderBrowse();
        } catch (err) {
          alert(err.message || 'An error occurred while saving.');
        }
      });
    });
  }

  // ===== Chat (Socket.IO) =====
  const socketScript = document.createElement('script'); socketScript.src='/socket.io/socket.io.js'; document.head.appendChild(socketScript);
  let socket=null, currentThreadId=null;
  function setConnBadge(state){
    const el=$('chatConn'); if(!el) return;
    if(state==='connected'){ el.textContent='Connected'; el.className='px-2 py-0.5 rounded bg-green-100 text-green-700'; }
    else if(state==='reconnecting'){ el.textContent='Reconnectingâ€¦'; el.className='px-2 py-0.5 rounded bg-amber-100 text-amber-700'; }
    else { el.textContent='Connecting...'; el.className='px-2 py-0.5 rounded bg-slate-200'; }
  }
  function setThreadConnBadge(state){
    const el=$('threadConn'); if(!el) return;
    if(state==='connected'){ el.textContent='Connected'; el.className='inline-block text-xs px-2 py-0.5 rounded bg-green-100 text-green-700'; }
    else if(state==='reconnecting'){ el.textContent='Reconnectingâ€¦'; el.className='inline-block text-xs px-2 py-0.5 rounded bg-amber-100 text-amber-700'; }
    else { el.textContent='Connecting...'; el.className='inline-block text-xs px-2 py-0.5 rounded bg-slate-200'; }
  }
  function appendChatRow({nick,text,ts}){ const wrap=$('chatLog'); if(!wrap) return; const row=document.createElement('div'); row.className='border rounded-xl px-3 py-2'; row.innerHTML=`<div class='text-sm font-medium'>${nick||'Anonymous'}</div><div class='text-sm whitespace-pre-wrap'>${(text||'').slice(0,2000)}</div><div class='text-[10px] text-slate-500 mt-1'>${new Date(ts).toLocaleString()}</div>`; wrap.insertBefore(row, wrap.firstChild); wrap.scrollTop=0; }
  function appendThreadRow({nick,text,ts}){ const wrap=$('threadLog'); if(!wrap) return; const row=document.createElement('div'); row.className='border rounded-xl px-3 py-2'; row.innerHTML=`<div class='text-sm font-medium'>${nick||'Anonymous'}</div><div class='text-sm whitespace-pre-wrap'>${(text||'').slice(0,2000)}</div><div class='text-[10px] text-slate-500 mt-1'>${new Date(ts).toLocaleString()}</div>`; wrap.appendChild(row); wrap.scrollTop=wrap.scrollHeight; }
  function initChat(){
    if (window.io===undefined){ socketScript.onload = initChat; return; }
    // Don't reinitialize if already initialized
    if (socket && socket.connected) return;
    socket = io({ withCredentials:false });
    socket.on('connect', ()=>{ setConnBadge('connected'); setThreadConnBadge('connected'); socket.emit('chat:join', { nick: $('chatNick')?.value?.trim()|| (ME?.name||'Anonymous') }); });
    socket.io.on('reconnect_attempt', ()=>{ setConnBadge('reconnecting'); setThreadConnBadge('reconnecting'); });
    socket.on('disconnect', ()=>{ setConnBadge('disconnected'); setThreadConnBadge('disconnected'); });
    socket.on('chat:history', (msgs=[])=>{ const wrap=$('chatLog'); if(wrap){ wrap.innerHTML=''; msgs.forEach(appendChatRow); wrap.scrollTop=0; } });
    socket.on('chat:new', (msg)=> appendChatRow(msg));
    socket.on('thread:history', ({itemId, msgs=[]})=>{ 
      if(itemId!==currentThreadId) return; 
      const log=$('threadLog'); 
      if(!log) return; 
      log.innerHTML=''; 
      msgs.forEach(appendThreadRow); 
    });
    socket.on('thread:new', ({itemId, msg})=>{ 
      // Debug logs only in development mode
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        console.log('ðŸ“¨ Thread message received:', {itemId, currentThreadId, msg});
      }
      if(itemId!==currentThreadId) {
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          console.log('âš ï¸ Ignoring message from different thread:', itemId, '!==', currentThreadId);
        }
        return;
      }
      appendThreadRow(msg); 
    });
    $('btnSend').addEventListener('click', ()=>{
      if (!socket?.connected) return;
      const nick = $('chatNick').value.trim() || (ME?.name||'Anonymous');
      const text = $('chatMsg').value.trim(); if(!text) return;
      socket.emit('chat:send', { nick, text, ts: new Date().toISOString() }); $('chatMsg').value='';
    });
    $('chatMsg').addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); $('btnSend').click(); } });
  }
  function joinThread(itemId){
    if (!socket || !socket.connected){ 
      console.warn('Socket not connected. Cannot join thread.');
      return; 
    }
    if (currentThreadId) socket.emit('thread:leave', { itemId: currentThreadId });
    currentThreadId = itemId;
    socket.emit('thread:join', { itemId, nick: $('threadNick')?.value?.trim()|| (ME?.name||'Anonymous') });
  }

  // ===== Mobile Menu =====
  function openMobileMenu(){
    const menu = $('mobileMenu');
    const overlay = $('mobileMenuOverlay');
    if (menu) menu.classList.remove('translate-x-full');
    if (overlay) overlay.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }
  function closeMobileMenu(){
    const menu = $('mobileMenu');
    const overlay = $('mobileMenuOverlay');
    if (menu) menu.classList.add('translate-x-full');
    if (overlay) overlay.classList.add('hidden');
    document.body.style.overflow = '';
  }

  // ===== Tab Switching =====
  function switchTab(tab){
    try {
      // Close mobile menu if open
      closeMobileMenu();
      
      // Hide all tabs - with null checks
      ['tabRegister','tabBrowse','tabAdmin','tabChat'].forEach(id=> {
        const el = $(id);
        if (el) el.classList.add('hidden');
      });
      
      // Show selected tab - with null check
      const selectedTab = $(tab);
      if (selectedTab) {
        selectedTab.classList.remove('hidden');
      } else {
        console.error('Tab not found:', tab);
        return;
      }
      
      // Update desktop button styles
      const navButtons = document.querySelectorAll('#desktopNav button');
      if (navButtons) {
        navButtons.forEach(b=> {
          if (b && b.id !== 'btnLoginToggle') {
            b.classList.replace('bg-primary-600','bg-slate-100');
            b.classList.replace('text-white','text-slate-700');
          }
        });
      }
      
      // Update mobile menu button styles
      const mobileNavButtons = document.querySelectorAll('#mobileMenu button');
      if (mobileNavButtons) {
        mobileNavButtons.forEach(b=> {
          if (b && b.id !== 'mobileBtnLoginToggle' && b.id !== 'mobileMenuClose') {
            b.classList.replace('bg-primary-600','bg-slate-100');
            b.classList.replace('text-white','text-slate-700');
          }
        });
      }
      
      const btnIdMap={
        tabRegister:'tabRegisterBtn', 
        tabBrowse:'tabBrowseBtn', 
        tabAdmin:'tabAdminBtn', 
        tabChat:'tabChatBtn'
      };
      const mobileBtnIdMap={
        tabRegister:'mobileTabRegisterBtn', 
        tabBrowse:'mobileTabBrowseBtn', 
        tabAdmin:'mobileTabAdminBtn', 
        tabChat:'mobileTabChatBtn'
      };
      
      // Update desktop button
      const btnEl=$(btnIdMap[tab]); 
      if (btnEl) {
        btnEl.classList.replace('bg-slate-100','bg-primary-600');
        btnEl.classList.replace('text-slate-700','text-white');
      }
      
      // Update mobile button
      const mobileBtnEl=$(mobileBtnIdMap[tab]);
      if (mobileBtnEl) {
        mobileBtnEl.classList.replace('bg-slate-100','bg-primary-600');
        mobileBtnEl.classList.replace('text-slate-700','text-white');
      }
      
      if (tab==='tabRegister'){ 
        if (!mapRegister) initRegisterMap(); 
        setTimeout(()=> { try { mapRegister?.invalidateSize(); } catch(e) { console.warn('Failed to invalidate register map size:', e); } }, 0); 
      }
      if (tab==='tabBrowse'){   
        if (!mapBrowse) initBrowseMap();   
        setTimeout(()=> { try { mapBrowse?.invalidateSize(); } catch(e) { console.warn('Failed to invalidate browse map size:', e); } }, 0); 
      }
    } catch (err) {
      console.error('Failed to switch tab:', err);
    }
  }

  // ===== Start =====
  function start(){
    // Ensure mobile menu is closed on page load
    closeMobileMenu();
    
    // Global error handler - prevent page blocking
    window.addEventListener('error', (e)=>{
      console.error('Global error:', e);
      // Don't show error message for resource loading errors (CDN failures)
      if (e.target && (e.target.tagName === 'SCRIPT' || e.target.tagName === 'LINK')) {
        return; // Let fallback mechanisms handle it
      }
      const msg=document.createElement('div'); 
      msg.className='fixed bottom-4 left-4 bg-rose-50 text-rose-700 border border-rose-200 rounded-lg px-3 py-2 shadow z-50 text-xs'; 
      msg.textContent='Script error: '+(e.message||''); 
      document.body.appendChild(msg); 
      setTimeout(()=> msg.remove(), 3500);
    });
    
    // Handle unhandled promise rejections
    window.addEventListener('unhandledrejection', (e)=>{
      console.error('Unhandled promise rejection:', e.reason);
      e.preventDefault(); // Prevent default browser error handling
    });

    // Tabs - with error handling and null checks
    const tabRegisterBtn = $('tabRegisterBtn');
    if (tabRegisterBtn) {
      tabRegisterBtn.addEventListener('click', ()=>{ try { switchTab('tabRegister'); } catch(e) { console.error('Tab switch error:', e); } });
    }
    const tabBrowseBtn = $('tabBrowseBtn');
    if (tabBrowseBtn) {
      tabBrowseBtn.addEventListener('click', ()=>{ try { switchTab('tabBrowse'); } catch(e) { console.error('Tab switch error:', e); } });
    }
    const tabAdminBtn = $('tabAdminBtn');
    if (tabAdminBtn) {
      tabAdminBtn.addEventListener('click', ()=>{ try { switchTab('tabAdmin'); } catch(e) { console.error('Tab switch error:', e); } });
    }
    const tabChatBtn = $('tabChatBtn');
    if (tabChatBtn) {
      tabChatBtn.addEventListener('click', ()=>{ try { switchTab('tabChat'); } catch(e) { console.error('Tab switch error:', e); } });
    }

    // Mobile menu buttons
    const mobileMenuBtn = $('mobileMenuBtn');
    if (mobileMenuBtn) {
      mobileMenuBtn.addEventListener('click', ()=>{ try { openMobileMenu(); } catch(e) { console.error('Mobile menu open error:', e); } });
    }
    const mobileMenuClose = $('mobileMenuClose');
    if (mobileMenuClose) {
      mobileMenuClose.addEventListener('click', ()=>{ try { closeMobileMenu(); } catch(e) { console.error('Mobile menu close error:', e); } });
    }
    const mobileMenuOverlay = $('mobileMenuOverlay');
    if (mobileMenuOverlay) {
      mobileMenuOverlay.addEventListener('click', ()=>{ try { closeMobileMenu(); } catch(e) { console.error('Mobile menu overlay click error:', e); } });
    }
    
    // Mobile tab buttons
    const mobileTabRegisterBtn = $('mobileTabRegisterBtn');
    if (mobileTabRegisterBtn) {
      mobileTabRegisterBtn.addEventListener('click', ()=>{ try { switchTab('tabRegister'); } catch(e) { console.error('Tab switch error:', e); } });
    }
    const mobileTabBrowseBtn = $('mobileTabBrowseBtn');
    if (mobileTabBrowseBtn) {
      mobileTabBrowseBtn.addEventListener('click', ()=>{ try { switchTab('tabBrowse'); } catch(e) { console.error('Tab switch error:', e); } });
    }
    const mobileTabAdminBtn = $('mobileTabAdminBtn');
    if (mobileTabAdminBtn) {
      mobileTabAdminBtn.addEventListener('click', ()=>{ try { switchTab('tabAdmin'); } catch(e) { console.error('Tab switch error:', e); } });
    }
    const mobileTabChatBtn = $('mobileTabChatBtn');
    if (mobileTabChatBtn) {
      mobileTabChatBtn.addEventListener('click', ()=>{ try { switchTab('tabChat'); } catch(e) { console.error('Tab switch error:', e); } });
    }

    // Form binding (doesn't depend on maps)
    bindRegisterForm();
    
    // Only initialize Register map here (default tab)
    // Browse map will be initialized when tab is switched
    initRegisterMap();

    // Search/Export/Import - with null checks
    const btnSearch = $('btnSearch');
    if (btnSearch) {
      btnSearch.addEventListener('click', ()=> { try { renderBrowse(); } catch(e) { console.error('Search error:', e); } });
    }
    const btnExport = $('btnExport');
    if (btnExport) {
      btnExport.addEventListener('click', async ()=>{
        try {
          const items = await loadItems();
          const data=JSON.stringify(items, null, 2);
          const blob=new Blob([data], {type:'application/json'});
          const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='lost_items_backup.json'; a.click(); URL.revokeObjectURL(url);
        } catch(e) {
          console.error('Export error:', e);
        }
      });
    }
    const inImport = $('inImport');
    if (inImport) {
      inImport.addEventListener('change', async (e)=>{
        const f=e.target.files?.[0]; if(!f) return;
        try{ 
          const text=await f.text(); 
          const arr=JSON.parse(text); 
          if(!Array.isArray(arr)) throw new Error('Invalid format');
          
          // Register each item through the API
          for (const item of arr) {
            try {
              await fetch('/api/items', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({
                  title: item.title,
                  desc: item.desc || item.description,
                  cat: item.cat || item.category,
                  imgData: item.imgData,
                  lat: item.lat,
                  lng: item.lng,
                  radius: item.radius || 0,
                  storagePlace: item.storagePlace
                })
              });
            } catch (err) {
              console.error('Item import failed:', item, err);
            }
          }
          
          await refreshItems();
          alert('Import completed'); 
          await renderBrowse(); 
          await renderAdminLists();
        }catch(err){ alert('JSON parsing failed: '+(err.message||err)); }
      });
    }

    // Close drawer + backdrop - with null checks
    const closeDrawer=()=>{ 
      const drawer = $('itemDrawer');
      const backdrop = $('drawerBackdrop');
      if (drawer) drawer.classList.add('hidden');
      if (backdrop) backdrop.classList.add('hidden');
    };
    const btnCloseDrawer = $('btnCloseDrawer');
    if (btnCloseDrawer) {
      btnCloseDrawer.addEventListener('click', closeDrawer);
    }
    const drawerBackdrop = $('drawerBackdrop');
    if (drawerBackdrop) {
      drawerBackdrop.addEventListener('click', closeDrawer);
    }

    // Chat
    try {
      initChat();
    } catch (e) {
      console.error('Failed to initialize chat:', e);
    }

    // Authentication state â†’ Reflect to UI then default tab
    fetchMe()
      .then(()=> {
        try {
          switchTab('tabRegister');
        } catch (e) {
          console.error('Failed to switch to default tab:', e);
        }
      })
      .catch(err => {
        console.error('Failed to fetch user info:', err);
        // Still try to show default tab even if auth fails
        try {
          switchTab('tabRegister');
        } catch (e) {
          console.error('Failed to switch to default tab:', e);
        }
      });
  }

  window.addEventListener('DOMContentLoaded', ()=>{
    // Start page initialization immediately - don't wait for anything
    // This ensures the page is functional even if CDN resources fail to load
    let pageStarted = false;
    function startPage() {
      if (pageStarted) return;
      pageStarted = true;
      try {
        start();
      } catch (err) {
        console.error('Failed to start page:', err);
        // Show user-friendly error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'fixed top-4 left-4 right-4 bg-yellow-50 border border-yellow-200 text-yellow-800 p-4 rounded-lg shadow-lg z-50 text-sm';
        errorDiv.innerHTML = '<strong>Warning:</strong> Some features may not work properly. Please check your network connection and refresh the page.';
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 10000);
      }
    }
    
    // Start page immediately - don't wait for Leaflet
    // Maps will initialize when needed
    startPage();
    
    // Optionally check for Leaflet in background (non-blocking)
    let tries=0; 
    const checkLeaflet = setInterval(()=>{
      if (window.L){ 
        clearInterval(checkLeaflet);
        // Leaflet loaded, maps can now be initialized when tabs are switched
      }
      else if (++tries>50){ 
        clearInterval(checkLeaflet); 
        console.warn('Leaflet loading timeout: Maps may not work. Page will continue without maps.');
      }
    }, 100);
  });
  </script>
</body>
</html>
